<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Equality Matters</title>
    <link rel="icon" type="image" href="img/teo-logo-hex.png">

    <!-- imports for bootstrap - jquery and popper are dependencies -->
    <script src="https://cdn.jsdelivr.net/gh/jquery/jquery@3.4.1/dist/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/twbs/bootstrap@v4.5.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/FezVrasta/popper.js@v1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/twbs/bootstrap@v4.5.2/dist/js/bootstrap.min.js"></script>

    <!-- fontawesome import -->
    <script src="https://kit.fontawesome.com/ee3848f0f5.js" crossorigin="anonymous"></script>

    <!-- chart.js and add ons -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js" integrity="sha512-Hn1w6YiiFw6p6S2lXv6yKeqTk0PLVzeCwWY9n32beuPjQ5HLcvz5l2QsP+KilEr1ws37rCTw3bZpvfvVIeTh0Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.min.js"></script>  
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/js/bootstrap-multiselect.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/css/bootstrap-multiselect.css" />

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.js"></script>
  <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/js/bootstrap-multiselect.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/css/bootstrap-multiselect.css">
    <link rel ="stylesheet" href ="style.css">

    <!-- <script src = "scripts/cookies_script.js"></script> -->

    <!-- import data for use in charts - needs to be imported in each script -->
      <!-- only useful here if some data transformations to happen in head section -->
    <!-- <script type="module">
      import * as data from './data.js';
    </script> -->
  </head>


  <body>
    <div class="wrapper">

      
      
      <nav class="warning">
        <div class="col-wide middle" style=" text-align: center;">
          <p style="margin-bottom: 0px;">We welcome feedback from users through our 
            <a class="survey-link" href="https://dttselfserve.nidirect.gov.uk/NISRA/RateIt#/Equality_Matters" target="_blank"><span style="color: white;">short survey</span>
              <!-- <img class = "new-tab" src = "img/opens-new-tab.svg"> -->
            </a>
            </p>
          
          </div>
      </nav>

      <!-- <div id="prototype">This prototype application will be enhanced as further equality indicator data is released.</div> -->

      <div id="top-container">
        <div id="top-menu" class="grid" style="margin: 0;">
          <div class="nisra-logo-container">
            <a href="https://www.nisra.gov.uk/" target="_blank"><img id="top-menu-nisra-logo" src="img/nisra-only-white.svg" alt="NISRA logo. Clicking image takes user to NISRA website"></a>
          </div>
          <div id="dashboard-title-container">
            <h1 id="dashboard-title"><a href="index.html">Equality Matters</a></h1>
          </div>
        </div>
      </div>

     <!--  <hr style="border-top: 10px solid #cedc20; margin: 0"> -->

      <main>

      <div id = "dest-scrn">
        <div id="content-centre">

    <div class="content-wrapper">
          
          <div id="main-container">

            <aside>
              <div id ="home-btn">
              </div>
              <h3 style="font-weight: normal; font-size: 14pt; margin-bottom: 0px; margin-top: 20px;">Explore other breakdowns for <p class = "measure_title" style="margin-bottom: 10px;"></p></h3>
              <form id = "selection-form" style="list-style-type: none; padding: 0;">
              <div id="top-buttons-container"></div>
              <!-- <hr style=" border-top: 3px solid rgba(0, 0, 0, .6); border-radius: 3px;"> -->
              <h3 style="display: none;" id="domains-title" style="font-weight: normal; font-size: 14pt; margin-bottom: 0px; margin-top: 20px;">Explore other measures by <p class = "eq_grp_name" style="color:#3878c5; font-weight: bold; margin-bottom: 10px;"></p></h3>              
              <div style="display: none;" id="key-metrics-container"></div>
            </form>
            </aside>

            <div id="main-content" class="screen">

                <div class="intro">
                  <div class = "breadcrumb-about-div">
                    <nav id="breadcrumb-destination" class="breadcrumb"></nav>
                    <button class="btn about-btn" name = "aboutbutton" alt="Home" onclick="window.location.href='about.html';">About Equality Matters</button>
                  </div>

                  <h2 style="margin-bottom: 30px;"><span class = "measure_title"></span> by <span class = "eq_grp_name"></span></h2>
                  <h3>How do we measure this?</h3>                  
                <h5><p id = "how_do_we_measure"></p></h5>
                </div>

                <div class="div-style-bar">
                  
                  <!-- <h3><span class = "measure_title"></span> <span class= "latest_year" style = "color:#3878c5;"></span></h3> -->
                  <h3>Latest year: <span class= "latest_year"></span></h3>
                  <div id ="barInfoContainer">
                    <!-- <p style="margin-bottom: 0px;">The following bar chart shows data on this measure for <span class= "latest_year" style="color:#3878c5; font-weight: bold;"></span> split by <span class = "eq_grp_name" style="color:#3878c5; font-weight: bold;"></span>.</p>
                    <p style="margin-bottom: 15px;">The Northern Ireland (NI) value is added for comparison in a blue line.</p> -->
                
                    <!-- <br><hr style="border-top:3px solid rgba(0, 0, 0, .6)"> -->

                    <button class="btn" id="chartBtn">View chart</button>
                    <button class="btn" id="tableBtn">View table</button>

                  </div>

                  <div id="chartView" class ="chart-container">
                    <button class="btn" id="downloadButton">Download chart as image</button>
                    <!-- <div class="chart-container"> -->
                    <canvas id="bar_line_chart"></canvas>
                  </div>

                  <div id="tableView" class="table-container">
                    <button class="copy-button">Copy table</button>
                    <table id="dataTable">
                      <thead>
                      </thead>
                      <tbody>
                      </tbody>
                    </table>
                  </div>
                  </div>
                    <!-- <h4 ">Summary of <span class= "latest_year"></span> data</h4> -->
                    <button class="accordion-button"><h4 style="margin-top: 20px;" class="accordion-header">Summary of <span class= "latest_year"></span> data </h4>(click to expand or hide) </button>
                    <div class="panel">
                    <p class="data_summary" style="margin-bottom: 10px; margin-top: 10px;"></p>
                    <button class="btn" id="copyTextButton" style="margin-bottom: 10px;">Copy Summary Text</button>
                    </div>
                

            <div id="chartInfoContainer">
                <h3 style="margin-top: 30px;">Time trend: <span class="start_year"></span> <span>to</span> <span class="latest_year"></span></h3>
                <!-- <p style="margin-bottom: 0px;">The following line chart shows data on this measure from <span class= "start_year" style="color:#3878c5; font-weight: bold;"></span> to <span class= "latest_year" style="color:#3878c5; font-weight: bold;"></span> split by <span class = "eq_grp_name" style="color:#3878c5; font-weight: bold;"></span>.</p> -->
                <p style="margin-bottom: 15px;">The Northern Ireland (NI) value is added for comparison in a blue dashed line.</p>
              <button class="btn" id="line_chartBtn">View chart</button>
              <button class="btn" id="line_tableBtn">View table</button>
              
              <div id="tableView2" class="table-container" style = "display: none;">
                <button class="copy-button" id="copy-button2">Copy table</button>        
                <table id="dataTable2">
                    <thead>
                        <tr>
                            <!-- Dynamically add columns for age groups -->
                            <tr id="ageGroupHeaders"></tr>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
              </div>
            </div>
            <div id="chartContainer" class="grid" style="margin-top: 30px;"></div>
            <div id ="lineDataSummaryContainer">
              <!-- <h4 style="margin-top: 20px;">Change over time summary</h4> -->
              <button class="accordion-button"><h4 class="accordion-header">Change over time summary </h4>(click to expand or hide) </button>
              <div class="panel">
              <p class="data_summary" id = "data_summary_2" style="margin-bottom: 10px; margin-top: 10px;"></p>
              <button class="btn" id="copyTextButton2" style="margin-bottom: 10px;">Copy Data Summary</button>
              </div>
            </div>
            
    
              <div>
                <br>
                <h3> Source</h3>
                <p style="margin-bottom: 10px;">Data originally collected and presented in:<br> <a class = "source_name" id="sourceId" target="_blank"></a></p>
                <p> Data presented here has been extracted from the NISRA Data Portal:<br> <a class="dataportal_name" id="portalId" target="_blank"></a></p>
              </div>
              
            <!-- accordion section    -->
              <!-- <h3>Notes</h3> -->
            <button class="accordion-button"><h3 class="accordion-header">Notes </h3>(click to expand or hide) </button>
              <div class="panel">
                <p id = "measureNotesParagraph" style="margin-bottom: 0px; font-weight: bold;font-size: 18px;">Notes on <span class = "measure_title" style="font-weight: bold;font-size: 18px;"></span></p>
                <p id = "notes_in_measure"></p>
                <p id = "groupNotesParagraph" style="margin-bottom: 0px; font-weight: bold;font-size: 18px;">Notes on <span class = "eq_grp_name" style="font-weight: bold;font-size: 18px;"></span></p>
                <p id = "notes_in_group"></p>
              </div> <!--close panel div-->
  
            </div> <!--closes main content div-->
          </div>
        </div>
      </div>
      </div>

      <div id="home-scrn" class="home-grid">
        <!-- Left side: 70% width, main content -->
        <div class="home-main">
          <h2>Explore NISRA Equality Data</h2>
          <h3 style="font-weight: normal;">Select an equality group to see the information available</h3>
          <!-- <form id = "selection-form-pathway" style="list-style-type: none; padding: 0;">
            <div id="pathways-container">
              <button name = "path" value = "s75">Section 75 Group</button>
              <button name = "path" value = "depart">Department</button>
            </div>
          </form> -->
          <form id = "selection-form-75group" style="list-style-type: none; padding: 0;">
          <div id="s75-groups-container"></div>
          </form>
        </div>
        <!-- Right side: 30% width, two stacked containers -->
        <div class="home-side">
          <div class="home-side-top">
            <div id="home_about_button"></div><br>  
            <div class="div-style-bar" style="margin-top: 0px; padding: 2rem;">
              <span><h4 style="color: #000;">Search by keyword or theme</h4></span>
              <div class="search-container" id="search-container">
                <input type="text" id="search-bar" placeholder="Search..." />
                <div id="dropdown"></div>
              </div>
            </div>
          </div>
          <div class="home-side-bottom">
            <form>
            <div class="div-style-bar" id ="all-meas-btn" style="padding: 2.8rem;">
              <button class="btn all-measures-btn" name = "allmeasures" style="margin-left: 0.4rem;">View all available measures</button>
            </div>
            </form>
          </div>
        </div>
      </div>
      
      <div id="all-measures-scrn">
        <div class="layout-container">
          <div class="main-body">

            <div class = "breadcrumb-about-div">
              <nav id="breadcrumb-all-measures" class="breadcrumb"></nav>
              <div id="allmeas_about_button"></div>
            </div>


            <div class="all-measures-div">
              <div class="header-row">
                <div class="left-section">
                  <h4>Filter measures by:</h4>
                              <div class="form-group">
              <select id="departmentSelect" class="form-control" multiple="multiple">
                  <option value="Census">Census</option>
                  <option value="Department for Communities">Department for Communities</option>
                  <option value="Department for Infrastructure">Department for Infrastructure</option>
                  <option value="Department for the Economy">Department for the Economy</option>
                  <option value="Department of Agriculture, Environment and Rural Affairs">Department of Agriculture, Environment and Rural Affairs</option>
                  <option value="Department of Education">Department of Education</option>
                  <option value="Department of Finance">Department of Finance</option>
                  <option value="Department of Health">Department of Health</option>
                  <option value="Department for Justice">Department for Justice</option>
                  <option value="The Executive Office">The Executive Office</option>
              </select>
            </div>
                </div>

                <div class="center-section">
                  <h2 style="padding-left: 7rem;">All Measures Page</h2>
                  <h5>Click a cell in the matrix below to view the equality statistics.</h5>
                  <h5>If a cell is empty, equality statistics are not currently available.</h5>
                </div>
              </div>

              
<h2 id="measures-header-all-meas" aria-live="polite" class="measures-header-all-meas">
  Measures available
</h2>

              <form id="selection-form-75group" style="list-style-type: none; padding: 0;">
                <div id="all-measures-container">
                  <table id="all-meas-tbl" border="1"></table>
                </div>
              </form>

            </div>
          </div>
        </div>
      </div>

      <div id="s75-scrn">
        <h2 style="text-align: center; margin-top: 20px;">Select a Section 75 Group to see available measures</h2>
        <form id = "selection-form-75group" style="list-style-type: none; padding: 0;">
          <div id="s75-groups-container">
            <button name = "home" value = "age">Age Group</button>
            <button name = "home" value = "depend">Dependant Status</button>
            <button name = "home" value = "disab">Disability</button>
            <button name = "home" value = "ethnic">Ethnic Group</button>
            <button name = "home" value = "marital">Marital Status</button>
            <button name = "home" value  = "political">Political Opinion</button>
            <button name = "home" value = "race">Racial Group</button>
            <button name = "home" value = "religion">Religious Belief</button>
            <button name = "home" value = "sex">Sex</button>
            <button name = "home" value = "ori">Sexual Orientation</button>
          </div>
        </form>
      </div>

      <div id="depart-scrn">
        <h2 style="text-align: center; margin-top: 20px;">Select a Department to see measures available</h2>
        <form id = "selection-form-depart" style="list-style-type: none; padding: 0;">
          <div id="depart-container">
            <button name = "depart" value = "cen">Census</button>
            <button name = "depart" value = "dfc">Department for Communities</button>
            <button name = "depart" value = "dfi">Department for Infrastructure</button>
            <button name = "depart" value = "dfe">Department for the Economy</button>
            <button name = "depart" value = "daera">Department of Agriculture, Environment and Rural Affairs</button>
            <button name = "depart" value = "de">Department of Education</button>
            <button name = "depart" value  = "dof">Department of Finance</button>
            <button name = "depart" value = "doh">Department of Health</button>
            <button name = "depart" value = "doj">Department for Justice</button>
            <button name = "depart" value = "teo">The Executive Office</button>
          </div>
        </form>
      </div>

      <div id="s75-measure-scrn">
      <div class="layout-container">
                
        <div class="main-body">

        <div class = "breadcrumb-about-div">
          <nav id="breadcrumb-inter-measures" class="breadcrumb"></nav>
          <div class="test">
          <h4>Group measures by:</h4>
        <div class="toggle-container">
          <div class="container" style="margin-left:-15px;">
              <select id="multiple-checkboxes" multiple="multiple">
                  <option value="Census">Census</option>
                  <option value="Department for Communities">Department for Communities</option>
                  <option value="Department for Infrastructure">Department for Infrastructure</option>
                  <option value="Department for the Economy">Department for the Economy</option>
                  <option value="Department of Agriculture, Environment and Rural Affairs">Department of Agriculture, Environment and Rural Affairs</option>
                  <option value="Department of Education">Department of Education</option>
                  <option value="Department of Finance">Department of Finance</option>
                  <option value="Department of Health">Department of Health</option>
                  <option value="Department for Justice">Department for Justice</option>
                  <option value="The Executive Office">The Executive Office</option>        
              </select>
          </div>
        </div>
        </div>
          <!-- <div id="inter_about_button"></div> -->
        </div>
        <h2 id="selection-heading" style="text-align: center; margin-top: 0px;"></h2>
        <h2 id="measures-header" aria-live="polite" class="measures-header">
  Measures available
</h2>

        <form id="measuresPageForm">
          <div id="new_button_container" class="container mt-4">
          <div class="container mt-4">
            <div class="row justify-content-center" id="buttonRow"></div>
          </div>
          </div>
        </form>
        <form id = "selection-form-measure" style="list-style-type: none; padding: 0;">
        <div id="key-metrics-container-inter" style="display: none;"></div>
          <div id="grouped-container" style="display: none;"></div>
        </form>
        </div>
      </div>
      </div>

      </main>
    <footer>
      <div id="footer-container">
        <!-- 3 column section -->
        <div class="row mb-3">
          <div class="col-md-4">
            <h5 class="footer-header">Data Tools</h5>
            <ul class="list-unstyled">
              <li><a href="https://explore.nisra.gov.uk/local-stats/" target="_blank">Local Statistics Explorer</a></li>
              <li><a href="https://data.nisra.gov.uk" target="_blank">Data Portal</a></li>
              <li><a href="https://build.nisra.gov.uk/en/" target="_blank">Census Flexible Table Builder</a></li>
            </ul>
          </div>
          <div class="col-md-4">
            <h5 class="footer-header">Corporate</h5>
            <ul class="list-unstyled">
              <li><a href="https://www.nisra.gov.uk/" target="_blank">NISRA website</a></li>
              <li><a href="https://www.nisra.gov.uk/statistics/about-nisra/careers" target="_blank">Careers</a></li>
              <li><a href="https://www.nisra.gov.uk/contact" target="_blank">Contact</a></li>
            </ul>
          </div>
          <div class="col-md-4" style="padding-bottom: 2rem">
            <h5 class="footer-header">Follow</h5>
            <ul class="list-inline">
              <li class="list-inline-item">
                <a href="https://www.facebook.com/nisra.gov.uk">
                  <img src="img/facebook-brands-solid-full.svg" alt="icon links to NISRA Facebook page" class="img-50">
                </a>
              </li>
              <li class="list-inline-item">
                <a href="https://x.com/NISRA/">
                  <img src="img/x-twitter-brands-solid-full.svg"alt="icon links to NISRA X page" class="img-50"/>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="https://www.youtube.com/user/nisrastats">
                  <img src="img/youtube-brands-solid-full.svg" alt="icon links to NISRA Youtube channel" class="img-50"/>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="https://www.linkedin.com/company/northern-ireland-statistics-and-research-agency/">
                  <img src="img/linkedin-in-brands-solid-full.svg" alt="icon links to NISRA linkedin" class="img-50"/>
                </a>
              </li>
            </ul>
          </div>
        </div>

        <!-- Horizontal list with separators -->
        <ul class="list-inline footer-links text-center mb-0">
          <li class="list-inline-item"><a href="https://www.nisra.gov.uk/crown-copyright" target="_blank">© Crown Copyright</a></li>
          <li class="list-inline-item">|</li>
          <li class="list-inline-item"><a href="https://www.nisra.gov.uk/terms-and-conditions" target="_blank">Terms and conditions</a></li>
          <li class="list-inline-item">|</li>
          <li class="list-inline-item"><a href="https://www.nisra.gov.uk/cookies" target="_blank">Cookies</a></li>
          <li class="list-inline-item">|</li>
          <li class="list-inline-item"><a href="https://www.nisra.gov.uk/nisra-privacy-notice" target="_blank">Privacy</a></li>
          <li class="list-inline-item">|</li>
          <li class="list-inline-item"><a href="https://www.nisra.gov.uk/accessibility-statement-nisra" target="_blank">Accessibility statement</a></li>
        </ul>

        <!-- <div class="row"> -->
          <!-- <div style="height: 170px; width: 350px; margin: 10px;">
            <h3 style="font-weight: 700; font-size: 18px; color: #ffffff">Data tools</h3>
            <a href="https://explore.nisra.gov.uk/local-stats/">Local Statistics Explorer</a><br>
            <a href="https://data.nisra.gov.uk/" target="_blank" rel="noopener noreferrer">Data Portal</a><br>
            <a href="https://build.nisra.gov.uk/en/">Census Flexible Table Builder</a>
            <a href="https://visual.nisra.gov.uk/" target="_blank" rel="noopener noreferrer">NISRA Interactive
              Data Visualisation Hub</a><br> -->
            <!-- <a href="https://www.opendatani.gov.uk/" target="_blank" rel="noopener noreferrer">OpenDataNI</a><br>
            <a href="https://www.nidirect.gov.uk" target="_blank" rel="noopener noreferrer">NIDirect</a><br>
            <a href="https://www.gov.uk/" target="_blank" rel="noopener noreferrer">GOV.UK</a><br> -->
          <!-- </div> -->
          <!-- <div style="height: 170px; width: 120px; margin: 20px 0px 20px 60px;">
            <h3 style="font-weight: 700; font-size: 18px; color: #ffffff">Follow NISRA</h3>
            <i class="fa-brands fa-facebook-f"></i> <a href="https://www.facebook.com/nisra.gov.uk" target="_blank"
              rel="noopener noreferrer">Facebook</a><br>
            <i class="fa-brands fa-x-twitter"></i> <a href="https://twitter.com/NISRA" target="_blank"
              rel="noopener noreferrer">Twitter</a><br>
            <i class="fa-brands fa-youtube"></i> <a href="https://www.youtube.com/user/nisrastats" target="_blank"
              rel="noopener noreferrer">YouTube</a><br>
          </div> -->
          <!-- <div id="teo-logo-container">
            <h4 style="margin-right: 20px; font-weight: normal; padding-bottom: 30px; color: #ffffff">Funded by:</h4>
            <a href="https://www.executiveoffice-ni.gov.uk/" target="_blank"><img id="footer-teo-logo" src="img/logo-white-teo.png" alt="The Executive Office logo. Clicking image takes user to TEO website"></a>
          </div> -->
        <!-- </div> -->
        <!-- <div class="flex-list-footer">
          <ul
            style="display: flex; flex-direction: row; flex-wrap: wrap; justify-content: space-between; margin-left: -1px;">
            <li class="cc-li" style="border-left:0px;"><a href="https://www.nisra.gov.uk/crown-copyright" target="_blank"
                rel="noopener noreferrer">© Crown Copyright</a></li> -->
            <!--<li class="cc-li"><a href="https://www.nisra.gov.uk/contacts/programme-government-analytics-executive-office"
                target="_blank" rel="noopener noreferrer">Contact us</a></li> --> 
            <!-- <li class="cc-li"><a href="https://consultations.nidirect.gov.uk/teo/d8cf2dfc" target="_blank">Leave
                feedback</a></li> -->
            <!-- <li class="cc-li"><a href="https://www.nisra.gov.uk/terms-and-conditions" target="_blank"
                rel="noopener noreferrer">Terms and conditions</a></li>
            <li class="cc-li"><a href="https://www.nisra.gov.uk/cookies" target="_blank"
                rel="noopener noreferrer">Cookies</a></li>
            <li class="cc-li"><a href="https://www.nisra.gov.uk/nisra-privacy-notice" target="_blank"
                rel="noopener noreferrer">Privacy</a></li>
            <li class="cc-li"><a href="https://www.nisra.gov.uk/accessibility-statement-nisra" target="_blank"
                rel="noopener noreferrer">Accessibility statement</a></li>
          </ul>
        </div> -->
      </div>
    </footer>
  </body>

    <script src = "scripts/cookies_script.js"></script>
    <script>
      window.onload = showCookieBanner;
    </script>
    <!-- <script src = "scripts/data_functions.js"></script>
    <script src = "scripts/navigation_functions.js"></script> -->

</html>

<script type="module">

  // import data for use in charts - needs to be imported in each script
  import * as data from './data.js';

  console.log("Dataset: ", data )

  const measure_code = Object.entries(data)
    .filter(([key, value]) => key.endsWith('_metadata') && value.dataset)
    .map(([_, value]) => value.dataset);

  console.log("Measure Code:", measure_code);
    
  const metadataEntries = Object.entries(data)
    .filter(([key, value]) => key.endsWith('_metadata') && value.dataset && value.title);
  const datasetsWithTitles = metadataEntries.map(([key, value]) => ({
    key,
    dataset: value.dataset,
    title: value.title
  }));

  let lookupTableEqCode = data.lookup_table_eq_code;
  let lookupTableDisplayGrp = data.lookup_table_display_grp;
  let lookupTableMeasureTitle = data.lookup_table_measure_title;
  let lookupTableDatasetLong = data.lookup_table_dataset_long;

  function filterVariablesByName(data, matchStrings) {
    if (!Array.isArray(matchStrings) || matchStrings.length !== 2) {
        throw new Error("matchStrings must be an array of exactly two strings");
    }

    const [match1, match2] = matchStrings;

    const filtered = Object.entries(data)
        .filter(([key]) => key.includes(match1) && key.includes(match2))
        .map(([, value]) => value); // Extract only the values

    return filtered.flat(); // Flatten the array if the values are arrays
  }

  // deals with the filling of the new nested button grid on S75 measures scrn
  (function () {
    var ACCORDION_ID = 'buttonAccordion';
    var GUTTER_MS = 150; // debounce

    function getColCount() {
      var w = window.innerWidth || document.documentElement.clientWidth;
      if (w >= 992) return 3;      // ≥ lg
      if (w >= 576) return 2;      // ≥ sm
      return 1;
    }

    function buildColumns(container, count) {
      // Extract existing items (preserve order)
      var items = Array.prototype.slice.call(container.querySelectorAll('.masonry-item'));

      // Clear container
      container.innerHTML = '';

      // Make columns
      var cols = [];
      for (var i = 0; i < count; i++) {
        var col = document.createElement('div');
        col.className = 'masonry-col';
        cols.push(col);
        container.appendChild(col);
      }

      // Distribute items in round-robin to keep top-to-bottom flow
      items.forEach(function (item, idx) {
        cols[idx % count].appendChild(item);
      });
    }

    function initMasonry() {
      var container = document.getElementById(ACCORDION_ID);
      if (!container) return;

      // If container already has .masonry-col children, collect back to a flat list first
      var existingCols = container.querySelectorAll('.masonry-col');
      if (existingCols.length) {
        var flatItems = [];
        existingCols.forEach(function (col) {
          flatItems = flatItems.concat(Array.prototype.slice.call(col.children));
        });
        container.innerHTML = '';
        flatItems.forEach(function (item) { container.appendChild(item); });
      }

      buildColumns(container, getColCount());
    }

    // Init on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMasonry);
    } else {
      initMasonry();
    }

    // Rebuild on resize (debounced)
    var resizeTimer;
    window.addEventListener('resize', function () {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(initMasonry, GUTTER_MS);
    });
  })();

  // filters the data based on a key and the returned values from a lookup - returns data arrays as an object
  function filterVariablesByLookup(data, lookupKey, matchString, lookupTable) {
    if (typeof lookupTable !== 'object' || lookupTable === null) {
        throw new Error("lookupTable must be a valid object");
    }
 
    if (!Object.prototype.hasOwnProperty.call(lookupTable, lookupKey)) {
        throw new Error(`lookupKey "${lookupKey}" not found in lookupTable`);
    }
 
    const lookupValues = lookupTable[lookupKey];
    if (!Array.isArray(lookupValues)) {
        throw new Error(`Value for lookupKey "${lookupKey}" must be an array`);
    }
 
    // Iterate through `lookupValues` to preserve order from `lookupTable`
    const filtered = [];
    const escapeRegExp = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

    for (const val of lookupValues) {
      const re = new RegExp(`(?:^|_)${escapeRegExp(val)}(?:_|$)`); // whole token match
      for (const [key, value] of Object.entries(data)) {
        if (
          key.includes(matchString) &&
          re.test(key) &&                 // matches EQ101 as a full token, not EQ1010
          !key.includes("_lci_") &&
          !key.includes("_uci_")
        ) {
          filtered.push([key, value]);
          break;
        }
      }
    }
    
    return Object.fromEntries(filtered); // Convert Map back to an object if needed
  }
  
  
  // filters the lci data based on a key and the returned values from a lookup - returns data arrays as an object
  function filterLciVariablesByLookup(data, lookupKey, matchString, lookupTable) {
    if (typeof lookupTable !== 'object' || lookupTable === null) {
        throw new Error("lookupTable must be a valid object");
    }

    if (!Object.prototype.hasOwnProperty.call(lookupTable, lookupKey)) {
        throw new Error(`lookupKey "${lookupKey}" not found in lookupTable`);
    }

    const lookupValues = lookupTable[lookupKey];
    if (!Array.isArray(lookupValues)) {
        throw new Error(`Value for lookupKey "${lookupKey}" must be an array`);
    }

    // Iterate through `lookupValues` to preserve order from `lookupTable`
    const lci_filtered = [];
 
    for (const val of lookupValues) {
        for (const [key, value] of Object.entries(data)) {
            if (key.includes(matchString) && key.includes(val) && key.includes("_lci_")) {
              lci_filtered.push([key, value]);
                break;  // Move to the next value once a match is found
            }
        }
    }

    return Object.fromEntries(lci_filtered);
  }

  // filters the uci data based on a key and the returned values from a lookup - returns data arrays as an object
  function filterUciVariablesByLookup(data, lookupKey, matchString, lookupTable) {
    if (typeof lookupTable !== 'object' || lookupTable === null) {
        throw new Error("lookupTable must be a valid object");
    }

    if (!Object.prototype.hasOwnProperty.call(lookupTable, lookupKey)) {
        throw new Error(`lookupKey "${lookupKey}" not found in lookupTable`);
    }

    const lookupValues = lookupTable[lookupKey];
    if (!Array.isArray(lookupValues)) {
        throw new Error(`Value for lookupKey "${lookupKey}" must be an array`);
    }

    // Iterate through `lookupValues` to preserve order from `lookupTable`
    const uci_filtered = [];
 
    for (const val of lookupValues) {
        for (const [key, value] of Object.entries(data)) {
            if (key.includes(matchString) && key.includes(val) && key.includes("_uci_")) {
              uci_filtered.push([key, value]);
                break;  // Move to the next value once a match is found
            }
        }
    }

    return Object.fromEntries(uci_filtered);
  }

  // returns a value from a lookup table based on matching a key value supplied
  function lookupValueByKey(key, lookupTable) {
    if (typeof lookupTable !== 'object' || lookupTable === null) {
        throw new Error("lookupTable must be a valid object");
    }

    if (!Object.prototype.hasOwnProperty.call(lookupTable, key)) {
        throw new Error(`Key "${key}" not found in lookupTable`);
    }

    // Return the corresponding value from the lookup table
    return lookupTable[key];
  }

  export function filterMetadataFromData(data, keyToMatch, fieldName) {
    if (typeof data !== 'object' || data === null) {
        throw new Error("data must be a valid object");
    }

    // Dynamically construct the key to search in the data object
    const fullKey = `${keyToMatch}_metadata`;

    if (!Object.prototype.hasOwnProperty.call(data, fullKey)) {
        throw new Error(`Key "${fullKey}" not found in data`);
    }

    const metadata = data[fullKey];
    if (typeof metadata !== 'object' || metadata === null) {
        throw new Error(`Value for key "${fullKey}" must be a valid object`);
    }

    if (!Object.prototype.hasOwnProperty.call(metadata, fieldName)) {
        throw new Error(`Field "${fieldName}" not found in the object for key "${fullKey}"`);
    }

    // Return the value associated with the fieldName
    return metadata[fieldName];
    console.log("Metadata", metadata)
  }

  // accepts the current S75 group value and returns all measures that are split by that group
  function returnS75CatsByLookup(data ,matchString, lookupTable) {
    if (typeof lookupTable !== 'object' || lookupTable === null) {
        throw new Error("lookupTable must be a valid object");
    }

    if (typeof matchString !== 'string' || matchString.trim() === "") {
        throw new Error("matchString must be a non-empty string");
    }

    // Ensure the matchString exists as a key in the lookupTable
    if (!Object.prototype.hasOwnProperty.call(lookupTable, matchString)) {
        throw new Error(`Key "${matchString}" not found in lookupTable`);
    }

    // Get the array of lookup values for the matchString
    const lookupValues = lookupTable[matchString];
    if (!Array.isArray(lookupValues) || lookupValues.length === 0) {
        throw new Error(`Value for key "${matchString}" in lookupTable must be a non-empty array`);
    }

    // Filter `data` keys that match any value in the lookupValues array
    const filteredKeys = Object.keys(data).filter(key =>
        lookupValues.some(val => key.includes(val))
    );

    // Extract unique prefixes (up to the first '_') from the filtered keys
    const uniquePrefixes = [...new Set(filteredKeys.map(key => key.split('_')[0]))];

    return uniquePrefixes;
  }

  // takes the output of returnS75CatsByLookup and matches to another lookup to get full titles
  function mapPrefixesToLookup(prefixes, lookup) {
    if (!Array.isArray(prefixes)) {
        throw new Error("Prefixes must be an array");
    }

    if (typeof lookup !== 'object' || lookup === null) {
        throw new Error("Lookup must be a valid object");
    }

    // Map each prefix to its corresponding value in the lookup
    const mappedValues = prefixes.map(prefix => {
        if (Object.prototype.hasOwnProperty.call(lookup, prefix)) {
            return lookup[prefix];
        } else {
            return null; // Return null if the prefix doesn't exist in the lookup
        }
    });

    return mappedValues;

  }

  // inverse lookup
  const invertObject = (lookupTableEqCode) => {
    const inverted = {};

    Object.entries(lookupTableEqCode).forEach(([key, values]) => {
      values.forEach(value => {
        if (!inverted[value]) {
          inverted[value] = [];
        }
        inverted[value].push(key);
      });
    });

    return inverted;
  };

  const invertedLookupEqCode = invertObject(lookupTableEqCode);
  console.log('inverted lookup:',invertedLookupEqCode);
 
 function returnAvailableS75ByLookup(data, matchString, lookupTable) {
      if (typeof lookupTable !== 'object' || lookupTable === null) {
          throw new Error("lookupTable must be a valid object");
      }

      if (typeof matchString !== 'string' || matchString.trim() === "") {
          throw new Error("matchString must be a non-empty string");
      }

      // Filter keys in `data` that contain `matchString`
      const matchedKeys = Object.keys(data).filter(key => key.includes(matchString));

      console.log("Matchstring", matchString)
      console.log("LookupTable", lookupTable)
      
      // Extract EQ values from matched keys (pattern: EQ followed by numbers up to next underscore)
      const eqValues = new Set();
      const eqPattern = /EQ\d+/g;
      
      matchedKeys.forEach(key => {
          const matches = key.match(eqPattern);
          if (matches) {
              matches.forEach(eq => eqValues.add(eq));
          }
      });

      // Look up extracted EQ values in lookupTable and collect unique matches
      const uniqueResults = new Set();
      eqValues.forEach(eq => {
          if (lookupTable.hasOwnProperty(eq)) {
              lookupTable[eq].forEach(value => uniqueResults.add(value));
          }
      });

      return [...uniqueResults];
  }


  // Get the current URL of the window
  let window_url = window.location.href;

  let group;  // Variable to store the 's75' parameter value
  let ind;  // Variable to store the 'key' parameter value
  let s75CatMeasures;  // Variable to store the measures associated with the 's75' value
  let path;
  let key_btns = document.getElementById("key-metrics-container").getElementsByTagName("button");  // Retrieves all button elements within the element that has the ID "key-metrics-container"
  let s75AvaiMeasures; 
  let s75_btns = document.getElementById("top-buttons-container").getElementsByTagName("button");
  let key_btns_inter = document.getElementById("key-metrics-container-inter").getElementsByTagName("button");  // Retrieves all button elements within the element that has the ID "key-metrics-container-inter"
  let dept_btns = document.getElementById("depart-container").getElementsByTagName("button");
  let measureTitle // Variable to store measure parameter;
  let eqGrpDisplayName // Variable to store group name;
  let nonNull; // variable for creating and hiding linecharts
  var home_scrn = document.getElementById("home-scrn");
  var all_meas_scrn = document.getElementById("all-measures-scrn");
  var s75_scrn = document.getElementById("s75-scrn");
  var depart_scrn = document.getElementById("depart-scrn");
  var s75_measure_scrn = document.getElementById("s75-measure-scrn");
  var dest_scrn = document.getElementById("dest-scrn");
    
  // default showing when no extra URL criteria - will apply to any part of the app
  // home_scrn shown as default for any div is block unless otherwise instructed
  // to counteract this, home_scrn will need to be hidden on every other page in if blocks
  s75_scrn.style.display = "none";
  depart_scrn.style.display = "none";
  s75_measure_scrn.style.display = "none";
  dest_scrn.style.display = "none";
 // home_scrn.style.display = "none";
  all_meas_scrn.style.display = "none";


document.addEventListener('DOMContentLoaded', function () {
  
  buildBreadcrumb();

  // Insert button into multiple locations
  // document.getElementById('inter_about_button').appendChild(createAboutButton());
  document.getElementById('allmeas_about_button').appendChild(createAboutButton());
  document.getElementById('home_about_button').appendChild(createAboutButton());

  // Constructing all measures table
  const exclusions = getS75ExclusionsFromLineData(data, invertedLookupEqCode);
  console.log("Exclusions from all measures", exclusions);

  // Dynamically build availableLinks
  const availableLinks = {};

  for (const measureKey in lookupTableMeasureTitle) {
    availableLinks[measureKey] = [];

    for (const groupKey in lookupTableDisplayGrp) {
      const excluded = exclusions[measureKey]?.includes(groupKey);
      if (!excluded) {
        availableLinks[measureKey].push(groupKey);
      }
    }
  }

  console.log("Links", availableLinks)

const dept_long_names = {
  "Census": "cen",
  "Department of Health": "doh",
  "Department of Education": "doe",
  "Department of Infrastructure": "dfi",
  "Department for Communities": "dfc",
  "Department for the Economy": "dfe",
  "The Executive Office": "teo",
  "Department of Agriculture, Environment and Rural Affairs": "daera",
  "Department of Finance": "dfc",
  "Department for Justice": "doj",
  "Department of Education": "de"
};

const codeToLongName = {};
for (const [longName, shortCode] of Object.entries(dept_long_names)) {
  codeToLongName[shortCode] = longName;
}

  let lookup_table_dept_name = data.lookup_table_dept_name;

// Build enrichedLookup using lookup_table_dept_name
const enrichedLookups = {};
for (const code in lookup_table_dept_name) {
  const deptCode = lookup_table_dept_name[code][0]; // short code like 'dfc'
  enrichedLookups[code] = {
    department: codeToLongName[deptCode] || deptCode // long name or fallback
  };
}


/**
 * Format a list like:
 * [] => ""
 * ["Census"] => "Census"
 * ["Census", "Department of Finance"] => "Census and Department of Finance"
 * ["A", "B", "C"] => "A, B and C"   (Oxford comma optional; set useOxfordComma=true to include it)
 */


/**
 * Format a list like:
 * [] => ""
 * ["Census"] => "Census"
 * ["Census", "Department of Finance"] => "Census and Department of Finance"
 * ["A", "B", "C"] => "A, B and C"   (Oxford comma optional; set useOxfordComma=true to include it)
 */
function formatListWithAnd(items, useOxfordComma = false) {
  const arr = (items || []).filter(Boolean);
  if (arr.length === 0) return '';
  if (arr.length === 1) return arr[0];
  if (arr.length === 2) return `${arr[0]} and ${arr[1]}`;
  const head = arr.slice(0, -1).join(', ');
  const tail = arr[arr.length - 1];
  return useOxfordComma ? `${head}, and ${tail}` : `${head} and ${tail}`;
}

/**
 * Update the header text according to selected departments.
 * - Default (none selected): "No filters applied - showing all measures"
 * - If selected equals all: "All Departments selected - showing all measures"
 * - Else: "Measures available for X and Y"
 */
function updateMeasuresHeader(selectedDepts = [], allDepts = []) {
  const headerEl = document.getElementById('measures-header');
  if (!headerEl) return;

  const selected = (selectedDepts || []).filter(Boolean);
  const all = (allDepts || []).filter(Boolean);

  const noneSelected = selected.length === 0;
  const allSelected = all.length > 0 && selected.length === all.length;

  if (noneSelected) {
    headerEl.textContent = 'No filters applied - showing all measures';
    return;
  } else if (allSelected) {
    headerEl.textContent = 'All Departments selected - showing all measures';
    return;
  }

  const formatted = formatListWithAnd(selected /*, true */); // pass true for Oxford comma
  headerEl.textContent = `Measures available for ${formatted}`;
}


// Main logic
let dataArray = [];
const selectedGroup = window_url.slice(window_url.indexOf("home=") + 5);

fetch('./measure_group_lookup.json')
  .then(response => response.json())
  .then(measure_lookup => {
    // Enrich the array
    dataArray = measure_lookup.map(entry => ({
      ...entry,
      dataset: 'example',
      s75_groups: availableLinks[entry.Code] || [],
      department: enrichedLookups[entry.Code]?.department || null // now uses long name
    }));

    let filtered = dataArray.filter(m => m.s75_groups.includes(selectedGroup));
    console.log("Filtered data", filtered)
    renderButtons(filtered);
    console.log("selectedGroup", selectedGroup);

    // Build attribute->departments map
    const attributeToDepartments = buildAttributeDepartmentMap(availableLinks, dataArray);
    console.log("dep_by_S75", attributeToDepartments);

    // Departments available for the currently selected S75 group (fallback list for header)
    const departmentsForGroup = attributeToDepartments[selectedGroup] || [];

    // Populate the multiselect with these departments
    const $deptSelect = $('#multiple-checkboxes');
    $deptSelect.empty(); // Clear previous options

    departmentsForGroup.forEach(dept => {
      $deptSelect.append(`<option value="${dept}">${dept}</option>`);
    });

    // Refresh the multiselect UI
    $deptSelect.multiselect('rebuild');

    // Initial header: show all available departments (or leave generic)
    updateMeasuresHeader([], departmentsForGroup);
  })
  .catch(error => console.error('Error loading JSON:', error));

// Multiselect initialization
$('#multiple-checkboxes').multiselect({
  includeSelectAllOption: false,
  buttonWidth: '180px',
  nonSelectedText: 'Department', // Placeholder text
  buttonText: function(options, select) {
    return 'Department'; // Always show this text
  }
});


$(document).ready(function() {
  $('#multiple-checkboxes').on('change', function() {
    const Departments = $(this).val() || [];
    console.log("Selected Departments:", Departments);

    // Update header to reflect current selection (with allDepts for all-selected detection)
    updateMeasuresHeader(Departments, $('#multiple-checkboxes option').map((_, opt) => opt.value).get());

    // Filter and re-render
    let filtered = dataArray.filter(m => m.s75_groups.includes(selectedGroup));
    if (Departments.length > 0) {
      filtered = filtered.filter(m => Departments.includes(m.department));
    }
    renderButtons(filtered);
  });
});

// Function to build the attribute -> [departments] map
function buildAttributeDepartmentMap(availableLinks, dataArray) {
  const result = {}; // { attribute: [departments] }

  for (const item of dataArray) {
    const code = item.Code;
    const dept = item.department;

    // Get attributes for this code from availableLinks
    const attrs = availableLinks[code];
    if (!attrs || !Array.isArray(attrs)) {
      // Skip codes not present in availableLinks
      continue;
    }

    // For each attribute under this code, add the department
    for (const attr of attrs) {
      if (!result[attr]) {
        result[attr] = [];
      }
      // Deduplicate departments
      if (!result[attr].includes(dept)) {
        result[attr].push(dept);
      }
    }
  }

  return result;
}

function getFocusableElements(container) {
  // Matches focusable controls including those with tabindex >= 0
  return Array.from(
    container.querySelectorAll(
      'a[href], area[href], button:not([disabled]), input:not([disabled]):not([type="hidden"]), ' +
      'select:not([disabled]), textarea:not([disabled]), ' +
      '[contenteditable]:not([contenteditable="false"]), ' +
      '[tabindex]:not([tabindex="-1"])'
    )
  ).filter(el => el.offsetParent !== null || el === document.activeElement); // visible or currently focused
}

// Apply 'inert' if supported; otherwise set aria-hidden and remove from tab order.
function makeBackgroundInertExcept(keepNodes) {
  const keep = new Set(keepNodes);
  const rootChildren = Array.from(document.body.children);
  rootChildren.forEach(node => {
    if (keep.has(node)) return;

    // If the browser supports 'inert' (Chrome, Edge, etc.), use it.
    if ('inert' in HTMLElement.prototype) {
      node.setAttribute('inert', '');
    } else {
      // Fallback: hide from AT and block tab focus by capturing current tabbables
      node.setAttribute('aria-hidden', 'true');
      node.__savedTabindex = [];
      const tabbables = node.querySelectorAll('[tabindex]:not([tabindex="-1"]), a[href], button, input, select, textarea');
      tabbables.forEach(t => {
        const hasExplicit = t.hasAttribute('tabindex');
        node.__savedTabindex.push([t, hasExplicit ? t.getAttribute('tabindex') : null]);
        t.setAttribute('tabindex', '-1');
      });
    }
  });

  // Keep a reference to restore later
  document.body.__inertApplied = true;
  document.body.__inertKept = keepNodes;
}

function restoreBackgroundInert() {
  if (!document.body.__inertApplied) return;
  const rootChildren = Array.from(document.body.children);
  rootChildren.forEach(node => {
    if ('inert' in HTMLElement.prototype) {
      node.removeAttribute('inert');
    } else {
      node.removeAttribute('aria-hidden');
      if (node.__savedTabindex) {
        node.__savedTabindex.forEach(([el, val]) => {
          if (val === null) {
            el.removeAttribute('tabindex');
          } else {
            el.setAttribute('tabindex', val);
          }
        });
        delete node.__savedTabindex;
      }
    }
  });
  delete document.body.__inertApplied;
  delete document.body.__inertKept;
}

/** ---- Accessible overlay management ---- **/

function closeAllNestedOverlays() {
  // Remove panel and backdrop
  document.querySelectorAll(".nested-overlay-panel").forEach(p => p.remove());
  document.querySelectorAll(".overlay-backdrop").forEach(b => b.remove());

  // Restore background interactivity
  restoreBackgroundInert();
  document.body.classList.remove('body--no-scroll');

  // Restore focus to the opener if we saved it
  const opener = document.body.__overlayOpener;
  if (opener && opener instanceof HTMLElement) {
    opener.focus();
    delete document.body.__overlayOpener;
  }

  // Remove global key handler
  document.removeEventListener('keydown', trapKeydown, true);

  // Clear panel ref
  __overlayPanel = null;
}

// We'll set these when opening to use inside the keydown trap
let __overlayPanel = null;

function trapKeydown(e) {
  if (!__overlayPanel) return;

  if (e.key === 'Escape') {
    e.preventDefault();
    closeAllNestedOverlays();
    return;
  }

  if (e.key === 'Tab') {
    const focusables = getFocusableElements(__overlayPanel);
    if (focusables.length === 0) {
      // Keep focus on the panel itself if nothing else is focusable
      e.preventDefault();
      __overlayPanel.focus();
      return;
    }

    const first = focusables[0];
    const last = focusables[focusables.length - 1];
    const current = document.activeElement;

    if (e.shiftKey) {
      if (current === first || current === __overlayPanel) {
        e.preventDefault();
        last.focus();
      }
    } else {
      if (current === last) {
        e.preventDefault();
        first.focus();
      }
    }
  }
}

function openNestedOverlay(anchorEl, innerHtml, { label = '', labelledById = '' } = {}) {
  closeAllNestedOverlays();

  // Save the opener to restore focus later
  document.body.__overlayOpener = anchorEl;

  // Build backdrop
  const backdrop = document.createElement('div');
  backdrop.className = 'overlay-backdrop';
  backdrop.addEventListener('click', closeAllNestedOverlays);
  document.body.appendChild(backdrop);

  // Build panel
  const panel = document.createElement('div');
  panel.className = 'nested-overlay-panel';
  panel.setAttribute('role', 'dialog');
  panel.setAttribute('aria-modal', 'true');
  // Labeling
  if (label) {
    panel.setAttribute('aria-label', label);
  }
  if (labelledById) {
    panel.setAttribute('aria-labelledby', labelledById);
  }
  // Make panel itself focusable so we can move focus to it if needed
  panel.setAttribute('tabindex', '-1');

  panel.innerHTML = innerHtml;
  document.body.appendChild(panel);

  // Hook up close buttons inside overlay
  panel.querySelectorAll(".js-overlay-close").forEach(b =>
    b.addEventListener("click", closeAllNestedOverlays)
  );

  // Positioning (your original logic)
  const r = anchorEl.getBoundingClientRect();
  const margin = 8;

  let top = r.bottom + margin + window.scrollY;
  let left = r.left + window.scrollX;

  const maxLeft = window.scrollX + document.documentElement.clientWidth - panel.offsetWidth - margin;
  left = Math.max(window.scrollX + margin, Math.min(left, maxLeft));

  const maxTop = window.scrollY + document.documentElement.clientHeight - panel.offsetHeight - margin;
  if (top > maxTop) {
    top = r.top + window.scrollY - panel.offsetHeight - margin;
    top = Math.max(window.scrollY + margin, top);
  }

  panel.style.top = `${top}px`;
  panel.style.left = `${left}px`;

  // Stop clicks inside from bubbling (so backdrop click can close)
  panel.addEventListener("click", (e) => e.stopPropagation());

  // Make the rest of the page inert (keyboard & AT)
  document.body.classList.add('body--no-scroll');
  makeBackgroundInertExcept([panel, backdrop]);

  // Focus handling: move focus to the first focusable in panel, else panel itself
  const focusables = getFocusableElements(panel);
  if (focusables.length) {
    focusables[0].focus();
  } else {
    panel.focus();
  }

  // Enable keyboard trap
  __overlayPanel = panel;
  document.addEventListener('keydown', trapKeydown, true);

  return panel; // in case you need a handle
}


// Render buttons function
function renderButtons(dataArray) {
  const buttonRow = document.getElementById("buttonRow");
  buttonRow.innerHTML = "";

  const nestedGroups = {};
  const nonNested = [];

  // Partition data into nested groups and non-nested items
  dataArray.forEach(item => {
    if (item.Nested === 'TRUE') {
      if (!nestedGroups[item.Group]) nestedGroups[item.Group] = [];
      nestedGroups[item.Group].push(item);
    } else {
      nonNested.push(item);
    }
  });

  // Render non-nested buttons
  nonNested.forEach(item => {
    const label = item.Measure_Name || enrichedLookup[item.Code]?.measure || 'Unnamed Measure';
    buttonRow.innerHTML += `
      <div class="col-md-4 mb-4 d-flex justify-content-center">
        <div class="card w-100">
          <div class="card-header p-0">
            <button form="measuresPageForm" type="submit" name="key" value="${item.Code}"
              class="btn btn-outline-primary btn-block">
              ${label}
            </button>
          </div>
        </div>
      </div>
    `;
  });

  // Render nested groups
  let collapseIndex = 0;
  window.__nestedOverlayContent = {}; // reset each render

  for (const [groupName, items] of Object.entries(nestedGroups)) {
    const overlayId = `overlay${collapseIndex}`;
    const titleId = `ovl-title-${collapseIndex}`;

    // Build inner child buttons
    const childButtons = items.map(item => {
      const label = item.Measure_Name || enrichedLookup[item.Code]?.measure || 'Unnamed Measure';
      return `
        <div class="mb-2">
          <button form="measuresPageForm" type="submit" name="key" value="${item.Code}"
            class="btn btn-outline-primary btn-block">
            ${label}
          </button>
        </div>
      `;
    }).join("");

    // Outer (parent) button that triggers overlay
    buttonRow.innerHTML += `
      <div class="col-md-4 mb-4 d-flex justify-content-center">
        <div class="card w-100">
          <div class="card-header p-0">
            <button
              type="button"
              class="btn btn-primary btn-block text-left btn-accordion nested-overlay-trigger"
              data-overlay-id="${overlayId}"
              data-overlay-title-id="${titleId}">
              ${groupName}
            </button>
          </div>
        </div>
      </div>
    `;

    // Store accessible overlay content, including a heading used for aria-labelledby
    window.__nestedOverlayContent[overlayId] = `
      <div class="p-2">
        <h2 id="${titleId}" class="h5 m-0">${groupName}</h2>
        <div class="mt-2">
          ${childButtons}
        </div>
        <div class="mt-3 d-flex justify-content-end">
          <button type="button" class="btn btn-sm btn-outline-secondary js-overlay-close">Close</button>
        </div>
      </div>
    `;

    collapseIndex++;
  }

  // Wire up overlay triggers (click opens; Enter/Space already work on buttons natively)
  buttonRow.querySelectorAll(".nested-overlay-trigger").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-overlay-id");
      const labelledById = btn.getAttribute("data-overlay-title-id"); // match the <h2 id="...">
      openNestedOverlay(btn, window.__nestedOverlayContent[id] || "", { labelledById });
    });

    // Optional: open with keyboard in case some UA customizations change default button behavior
    btn.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        const id = btn.getAttribute("data-overlay-id");
        const labelledById = btn.getAttribute("data-overlay-title-id");
        openNestedOverlay(btn, window.__nestedOverlayContent[id] || "", { labelledById });
      }
    });
  });
}

  // Function to check and store the relevant URL
  function storeRelevantUrl() {
    const currentUrl = window.location.href;

    // Check if URL contains home= or allmeasures=
    if (currentUrl.includes('home=') || currentUrl.includes('allmeasures=')) {
        localStorage.setItem('lastRelevantUrl', currentUrl);
    }
  }

  // Call this on page load
  storeRelevantUrl();

  // Retrieve later
  const lastRelevantUrl = localStorage.getItem('lastRelevantUrl');
  console.log('Last relevant URL:', lastRelevantUrl);


  // // Add dataset to each measure_lookup entry
  // const enriched_measure_lookup = measure_lookup.map(entry => ({
  //   ...entry,
  //   dataset: titleToDatasetMap[entry.Group] || null  // null if no match found
  // }));

  // console.log("enriched", enriched_measure_lookup);

  // Show the page when the script is done (prevents flickering)
  document.body.style.visibility = "visible"; 

  const searchBar = document.getElementById('search-bar');
  const dropdown = document.getElementById('dropdown');


searchBar.addEventListener('input', function () {
  const query = searchBar.value.toLowerCase();
  dropdown.innerHTML = '';
  dropdown.style.display = 'none';

  if (query.length === 0) return;

  const results = [];
  const matchedCategories = [];

  for (const [category, words] of Object.entries(relatedWordsLookup)) {
    if (words.some(word => query.includes(word))) {
      matchedCategories.push(category);
    }
  }

  for (const [measureKey, measureTitles] of Object.entries(lookupTableMeasureTitle)) {
    const measureExclusions = exclusions[measureKey] || [];

    for (const [groupKey, groupTitles] of Object.entries(lookupTableDisplayGrp)) {
      const groupTitleLower = groupTitles[0].toLowerCase();

      if (measureExclusions.some(ex => groupKey.includes(ex) || groupTitleLower.includes(ex))) {
        continue;
      }

      const label = `${measureTitles[0]} <em>by ${groupTitles[0]}</em>`;
      const labelLower = label.toLowerCase();

      const isDirectMatch = labelLower.includes(query);
      const isRelatedMatch = matchedCategories.some(cat => labelLower.includes(cat));

      if (isDirectMatch || isRelatedMatch) {
        // Highlight the matching part
        const highlightedLabel = label.replace(
          new RegExp(query, 'gi'),
          match => `<strong>${match}</strong>`
        );

        results.push({
          label: highlightedLabel,
          url: `${window_url}?s75=${groupKey}&key=${measureKey}`
        });
      }
    }
  }

  if (results.length > 0) {
    dropdown.style.display = 'block';
    results.forEach(result => {
      const item = document.createElement('div');
      item.className = 'dropdown-item';
      item.innerHTML = result.label; // Use innerHTML to render <strong> and <em>
      item.onclick = () => window.location.href = result.url;
      dropdown.appendChild(item);
    });
  }
});

document.addEventListener('click', function (e) {
  if (!document.getElementById('search-container').contains(e.target)) {
    dropdown.style.display = 'none';
  }
});

  const form = document.getElementById("selection-form-measure");
  const groupedContainer = document.getElementById("grouped-container");
  let isGrouped = false;

  let filteredButtons = [];

  if (window_url.indexOf("?") > -1 && window_url.indexOf("allmeasures=") > -1) {
    home_scrn.style.display = "none";
    s75_scrn.style.display = "none";
    s75_measure_scrn.style.display = "none";
    dest_scrn.style.display = "none";
    all_meas_scrn.style.display = "block";
  }

  // if block denoting action when a button is clicked from the home screen - returns measures within s75 selection
  if (window_url.indexOf("?") > -1 && window_url.indexOf("home=") > -1) {
    home_scrn.style.display = "none";
    s75_scrn.style.display = "none";
    s75_measure_scrn.style.display = "flex";
    dest_scrn.style.display = "none";

    const group = window_url.slice(window_url.indexOf("home=") + 5);
    localStorage.setItem("s75", group);

    const matchedBtn = document.querySelector(`button[name="home"][value="${group}"]`);

    if (matchedBtn) {
      const friendlyLabel = matchedBtn.textContent.trim();
      const selectionHeading = document.getElementById("selection-heading");
      selectionHeading.textContent = `Available Measures within ${friendlyLabel}`;
    }

    const s75_cats = returnS75CatsByLookup(data, group, lookupTableEqCode);

    const allButtons = Array.from(form.querySelectorAll('button[name="key"]'));

    // Hide all buttons first
    allButtons.forEach(btn => btn.style.display = 'none');

    // Filter the matching buttons
    filteredButtons = allButtons.filter(btn => s75_cats.includes(btn.value));

    // Show only the filtered ones (let CSS grid handle layout)
    filteredButtons.forEach(btn => btn.style.display = '');

    if (groupedContainer.style.display === "block") {
      renderGroupedButtons(filteredButtons);
    }


  }

  const deptLookup = {};  
  const urlParams = new URLSearchParams(window.location.search);
  const selectedS75 = urlParams.get('home'); // e.g. 'age'

    const deptLookupLong = {};
  // Step 2: Enrich measure titles using deptLookup
  const enrichedLookup = {};

  for (const code in lookupTableMeasureTitle) {
    const measureName = lookupTableMeasureTitle[code][0];
    const deptName = deptLookup[code] || 'Unknown Department';
    enrichedLookup[code] = {
      measure: measureName,
      department: deptName
    };
  }

  const intermeascontainer = document.getElementById('key-metrics-container-inter');

  const s75MeasureMap = getS75InclusionsFromLineData(data, invertedLookupEqCode);
  const invertedMeasureMap = {};

  for (const [measure, groups] of Object.entries(s75MeasureMap)) {
    groups.forEach(group => {
      if (!invertedMeasureMap[group]) {
        invertedMeasureMap[group] = [];
      }
      invertedMeasureMap[group].push(measure);
    });
  }

  // Now `invertedMeasureMap` is structured like your original `s75MeasureMap`
  console.log("Invi", invertedMeasureMap);

  const allowedKeys = invertedMeasureMap[selectedS75] || [];

  for (const key of allowedKeys) {
    if (enrichedLookup[key]) {
      const { measure, department } = enrichedLookup[key];
      const button = document.createElement('button');
      button.name = 'key';
      button.value = key;
      button.textContent = measure;
      button.setAttribute('category', department);
      intermeascontainer.appendChild(button);
    }}

    
  // Update filteredButtons after dynamic creation
  filteredButtons = Array.from(intermeascontainer.querySelectorAll('button[name="key"]'));
  const flatContainer = document.getElementById("key-metrics-container-inter");
  

function renderGroupedButtons(buttons) {
  groupedContainer.innerHTML = "";

  // ✅ Define these at the top of the function
  const customCategoryOrder = [
    "Census",
    "Department of Health",
    "Department of Education",
    "Department of Infrastructure",
    "Department for Communities",
    "Department for the Economy",
    "The Executive Office"
  ];

  const categoryIcons = {
    "Census": "img/cen-logo-hex.png",
    "Department of Health": "img/doh-logo-hex.png",
    "Department of Education": "img/doe-logo-hex.png",
    "Department of Infrastructure": "img/dfi-logo-hex.png",
    "Department for Communities": "img/dfc-logo-hex.png",
    "Department for the Economy": "img/dfe-logo-hex.png",
    "The Executive Office": "img/teo-logo-hex.png",
    "Uncategorized": "img/default-logo.png" // ✅ fallback logo
  };

  const categoryColors = {
    "Census": "cen-theme",
    "Department of Health": "doh-theme",
    "Department of Education": "doe-theme",
    "Department of Infrastructure": "dfi-theme",
    "Department for Communities": "dfc-theme",
    "Department of Economy": "dfe-theme",
    "The Executive Office": "teo-theme"
  };

  // ✅ Group buttons by category
  const groups = new Map();

  buttons.forEach(btn => {
    const rawCat = btn.getAttribute("category") || "Uncategorized";
    const cat = rawCat.trim();
    if (!groups.has(cat)) {
      groups.set(cat, []);
    }
    groups.get(cat).push(btn);
  });

  // ✅ Render groups in custom order
  customCategoryOrder.forEach(cat => {
    if (groups.has(cat)) {
      renderGroup(cat, groups.get(cat));
      groups.delete(cat);
    }
  });

  // ✅ Render remaining groups
  groups.forEach((btnArray, cat) => {
    renderGroup(cat, btnArray);
  });

  // ✅ Helper function to render each group
  function renderGroup(cat, btnArray) {
    const groupDiv = document.createElement("div");
    groupDiv.classList.add("category-grp");

    const title = document.createElement("h3");

    const icon = document.createElement("img");

    // ✅ Check if logo exists, fallback if not
    if (!categoryIcons[cat]) {
      console.warn(`No logo found for category "${cat}". Using default.`);
    }

    icon.src = categoryIcons[cat] || categoryIcons["Uncategorized"];
    icon.alt = `${cat} logo`;
    icon.style.height = "70px";
    icon.style.verticalAlign = "middle";
    icon.style.marginRight = "8px";

    title.appendChild(icon);
    title.appendChild(document.createTextNode(cat));
    groupDiv.appendChild(title);

    const btnWrapper = document.createElement("div");
    btnWrapper.classList.add("category-grp-btn");

    const themeClass = categoryColors[cat] || "default-theme";

    btnArray.forEach((origBtn, index) => {
      const clone = origBtn.cloneNode(true);
      clone.className = `${origBtn.className} ${themeClass} staggered-entry`;
      clone.style.setProperty('--delay', `${index * 100}ms`);

      clone.addEventListener("click", () => {
        origBtn.click();
      });

      btnWrapper.appendChild(clone);
    });

    groupDiv.appendChild(btnWrapper);
    groupedContainer.appendChild(groupDiv);
  }
  
console.log(`Rendering logo for category: "${cat}"`);
console.log(`Resolved logo path: "${categoryIcons[cat]}"`)

}

function formatListWithAnd(items, useOxfordComma = false) {
  const arr = (items || []).filter(Boolean);
  if (arr.length === 0) return '';
  if (arr.length === 1) return arr[0];
  if (arr.length === 2) return `${arr[0]} and ${arr[1]}`;
  const head = arr.slice(0, -1).join(', ');
  const tail = arr[arr.length - 1];
  return useOxfordComma ? `${head}, and ${tail}` : `${head} and ${tail}`;
}

/**
 * Update header text according to selected departments.
 * - Default: "No filters applied - showing all measures" on initial load.
 * - If none selected: same as default.
 * - If all selected: same as default.
 * - Otherwise: "Measures available for X and Y" etc.
 */
function updateMeasuresHeaderForDepartments(selectedDepts, allDepts) {
  const headerEl = document.getElementById('measures-header-all-meas');
  if (!headerEl) return;

  const selected = (selectedDepts || []).filter(Boolean);
  const all = (allDepts || []).filter(Boolean);

  const noneSelected = selected.length === 0;
  const allSelected = all.length > 0 && selected.length === all.length;

  if (noneSelected) {
    headerEl.textContent = 'No filters applied - showing all measures';
    return;
  } else if (allSelected) {
    headerEl.textContent = 'All Departments selected - showing all measures';
    return;
  }

  const formatted = formatListWithAnd(selected /* , true */); // pass true for Oxford comma
  headerEl.textContent = `Measures available for ${formatted}`;
}


$(function () {
  // Populate multiselect with long department names from enrichedLookups
  const $deptSelect = $('#departmentSelect');
  $deptSelect.empty();

  // Extract unique department names from enrichedLookups
  const uniqueDepartments = [...new Set(
    Object.values(enrichedLookups)
      .map(d => d?.department?.trim())
      .filter(Boolean)
  )];

  uniqueDepartments.forEach(dept => {
    $deptSelect.append(`<option value="${dept}">${dept}</option>`);
  });

  // Initialize multiselect
  $deptSelect.multiselect({
    includeSelectAllOption: false,
    enableFiltering: false, // No search box
    buttonWidth: '180px',
    nonSelectedText: 'Department',
    buttonText: function () {
      return 'Department'; // Always show this text
    },
    onChange: function () {
      const selected = $('#departmentSelect').val() || [];

      // Update header based on selection
      updateMeasuresHeaderForDepartments(selected, uniqueDepartments);

      // Render table rows for the selected departments
      renderTable(selected);
    }
  });

  const table = document.getElementById('all-meas-tbl');

  // Create header row
  const headerRow = document.createElement('tr');
  const thMeasure = document.createElement('th');
  thMeasure.textContent = 'Measure';
  headerRow.appendChild(thMeasure);

  for (const grpKey in lookupTableDisplayGrp) {
    const th = document.createElement('th');
    th.textContent = lookupTableDisplayGrp[grpKey][0];
    headerRow.appendChild(th);
  }
  table.appendChild(headerRow);

  // Render table rows filtered by selected departments
  function renderTable(selectedDepartmentsArray = []) {
    // Clear previous rows
    table.querySelectorAll('tr:not(:first-child)').forEach(row => row.remove());

    for (const measureKey in lookupTableMeasureTitle) {
      const department = enrichedLookups[measureKey]?.department?.trim();
      if (!department) continue;

      // Show all if no selection OR filter by selected departments
      if (selectedDepartmentsArray.length === 0 || selectedDepartmentsArray.includes(department)) {
        const row = document.createElement('tr');

        const tdTitle = document.createElement('td');
        tdTitle.classList.add('wrap-cell');
        tdTitle.textContent = lookupTableMeasureTitle[measureKey][0];
        row.appendChild(tdTitle);

        for (const grpKey in lookupTableDisplayGrp) {
          const td = document.createElement('td');

          if (availableLinks[measureKey]?.includes(grpKey)) {
            td.style.cursor = 'pointer';
            td.setAttribute('tabindex', '0'); // Make cell focusable
            td.setAttribute('role', 'link');  // Screen reader: behaves like a link

            // Add descriptive label for screen readers
            const measureName = lookupTableMeasureTitle[measureKey][0];
            const groupName = lookupTableDisplayGrp[grpKey][0];
            td.setAttribute('aria-label', `Click for ${measureName} by ${groupName}`);

            // Click navigation
            td.addEventListener('click', () => {
              window.location.href = `?s75=${grpKey}&key=${measureKey}`;
            });

            // Keyboard navigation
            td.addEventListener('keydown', (event) => {
              if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                window.location.href = `?s75=${grpKey}&key=${measureKey}`;
              }
            });

            td.innerHTML = '<div class="navy-dot"></div>';
          }

          row.appendChild(td);
        }
        table.appendChild(row);
      }
    }
  }

  // Initial header and table render
  // Default header: "No filters applied - showing all measures"
  updateMeasuresHeaderForDepartments([], uniqueDepartments);
  renderTable();
});

// Create home page s75 buttons dynamically
const container = document.getElementById('s75-groups-container');

for (const key in lookupTableDisplayGrp) {
  const label = lookupTableDisplayGrp[key][0]; // Get label from array
  const button = document.createElement('button');
  button.name = 'home';           // Link to measures logic
  button.value = key;             // Use key as value
  button.textContent = label;     // Use label as button text
  container.appendChild(button);
}

// Create destination page home buttons dynamically
const destcontainer = document.getElementById('top-buttons-container');

for (const key in lookupTableDisplayGrp) {
  const label = lookupTableDisplayGrp[key][0];
  const button = document.createElement('button');
  button.name = 's75';
  button.value = key;
  button.textContent = label;
  destcontainer.appendChild(button);
}

const s75_btns = destcontainer.getElementsByTagName('button');
const s75AvaiMeasures = returnAvailableS75ByLookup(data, ind, invertedLookupEqCode);

for (let n = 0; n < s75_btns.length; n++) {
  if (s75AvaiMeasures.includes(s75_btns[n].value)) {
    s75_btns[n].style.display = 'block';
  } else {
    s75_btns[n].style.display = 'none';
  }
}

// Create destination page buttons dynamically
const meascontainer = document.getElementById('key-metrics-container');

for (const key in lookupTableMeasureTitle) {
  const label = lookupTableMeasureTitle[key][0]; // Get label from array
  const button = document.createElement('button');
  button.name = 'key';           // Link to measures logic
  button.value = key;             // Use key as value
  button.textContent = label;     // Use label as button text
  meascontainer.appendChild(button);
}


});

// action taken to update url once a s75 measure given - this being actioned triggers the below if block and populates the dest page based on the key and s75 in the url
const urlParams = new URLSearchParams(window.location.search);
const key = urlParams.get("key");
const s75 = urlParams.get("s75");

console.log("Key:", key)
console.log("S75:", s75)

// Add a related words lookup table
const relatedWordsLookup = {
  transport: ['bus', 'train', 'tram', 'subway', 'commute', 'public transport'],
  walking: ['walk', 'walking', 'cycle', 'bike', 'bicycle'],
  arts: ['music', 'dance', 'theatre', 'art', 'gallery'],
  population: ['people', 'residents', 'inhabitants'],
};

if (key && !s75) {
  const group = localStorage.getItem("s75");
  if (group) {
    urlParams.set("s75", group);
    const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
    if (window.location.search !== `?${urlParams.toString()}`) {
      window.location.replace(newUrl); // avoids history loop
    }
  }
  } else {
  // Optional: store current values for future use
  if (s75) localStorage.setItem("s75", s75);
  if (key) localStorage.setItem("key", key);
}

if (window_url.indexOf("?") > -1 && window_url.indexOf("s75=") > -1) {
  // Check if the URL contains a query string ('?') and // Check if the parameter 's75' exists in the URL
  home_scrn.style.display = "none";
  dest_scrn.style.display = "flex";

// Check if the URL contains a query string ('?')
let selections = window_url.slice(window_url.indexOf("?") + 1).split("&");
  // Extract the query string part after '?' and split it into key-value pairs
  let base_url = window_url.slice(0, window_url.indexOf("?"));
  // Extract the base URL without query parameters
  for (let i = 0; i < selections.length; i++) {
    // Loop through each key-value pair in the query string
    if (selections[i].indexOf("s75=") > -1) {
      // Check if the parameter 's75' exists in the URL
      group = selections[i].slice(selections[i].indexOf("s75=") + 4);
      // Extract the value of 's75' (after "s75=")
      localStorage.setItem("s75", group);
      // Store the 's75' value in localStorage for persistence
      s75CatMeasures = returnS75CatsByLookup(data, group, lookupTableEqCode);
      // Call a function to retrieve measures associated with 's75'
      for (let j = 0; j < key_btns.length; j++) {  
        // Loop through all buttons in "key-metrics-container"
        if (s75CatMeasures.includes(key_btns[j].value)) {  
          // If the button's value is in the list of valid measures, show it
          key_btns[j].style.display = "none"; // changed to none while testing not displaying measures on destination page
        } else {
          // Otherwise, hide the button
          key_btns[j].style.display = "none";
        }
      } 

      if (s75CatMeasures.includes(localStorage.getItem("key"))) {
        // If the current stored 'key' is still a valid option
        ind = localStorage.getItem("key");
      } else {
        // Otherwise, default to the first available measure
        console.log("Not a valid measure");
        ind = s75CatMeasures[0];
      }
    }
    if (selections[i].indexOf("key=") > -1) {
      // Check if the parameter 'key' exists in the URL
      ind = selections[i].slice(selections[i].indexOf("key=") + 4);
      // Extract the value of 'key' (after "key=")
      localStorage.setItem("key", ind);
      // Store the 'key' value in localStorage for persistence
      group = localStorage.getItem("s75");
      // Retrieve the stored 's75' value
    }
      if (window.location.href != base_url + "?s75=" + group + "&key=" + ind) {
    // If the URL is not already formatted correctly with the selected values
    window.location.href = base_url + "?s75=" + group + "&key=" + ind;
    // Redirect to the updated URL to ensure correct parameters are set
  }}}

  if (window_url.indexOf("?") > -1) {
  // run if there is a '?' in the url

  // Update document title
  measureTitle = lookupValueByKey(ind, lookupTableMeasureTitle);
  eqGrpDisplayName = lookupValueByKey(group, lookupTableDisplayGrp);
  document.getElementsByTagName("title")[0].textContent += " - " + measureTitle + " by " + eqGrpDisplayName;
  }  


  // ################################################################################
  // ################################################################################
  // ################################################################################
  // ################################################################################

  let yearLabels = filterVariablesByName(data, [ind, 'line_labels']);
  let niLineData = filterVariablesByName(data, [ind, 'ni_']);
  let niAvgLine = niLineData[niLineData.length - 1];
  let eqGrpCatLabelsName =  "_" + group + "_category_labels";
  let eqGrpCatLabels = filterVariablesByName(data, [ind, eqGrpCatLabelsName]);
  let eqGrpCatLineData = filterVariablesByLookup(data, group, ind, lookupTableEqCode);
  let eqGrpLciCatLineData = filterLciVariablesByLookup(data, group, ind, lookupTableEqCode);
  let eqGrpUciCatLineData = filterUciVariablesByLookup(data, group, ind, lookupTableEqCode);
  let eqGrpCatBarData = Object.values(eqGrpCatLineData).map(value => value[value.length - 1]);
  let eqGrpLciCatBarData = Object.values(eqGrpLciCatLineData).map(value => value[value.length - 1]);
  let eqGrpUciCatBarData = Object.values(eqGrpUciCatLineData).map(value => value[value.length - 1]);
  let numEQGrpCats = eqGrpCatLabels.length;
  let startYear = filterMetadataFromData(data, ind, "start_year");
  let latestYear = filterMetadataFromData(data, ind, "end_year");
  let datasetLongName = lookupValueByKey(ind, lookupTableDatasetLong);
  let s75CatMeasuresTitle = mapPrefixesToLookup(s75CatMeasures, lookupTableMeasureTitle);
  let s75CatNotesLabelsName =  "_" + group + "_section75_notes";
  let s75CatNotesLabels = filterVariablesByName(data, [ind, s75CatNotesLabelsName]);
  let furtherInfo = data[`${ind}_further_information`];
  let s75grps = returnAvailableS75ByLookup(data,ind,invertedLookupEqCode);

  console.log('Year Labels:', yearLabels);
  console.log('N.I. Line Data:', niLineData);
  console.log('N.I. Average Line:', niAvgLine);
  console.log('EQ Group Category Labels:', eqGrpCatLabels);
  console.log('EQ Category Data:', eqGrpCatLineData);
  console.log('EQ Group Display Name:', eqGrpDisplayName);
  console.log('Bar Data:', eqGrpCatBarData);
  console.log('LCI Bar Data:', eqGrpLciCatBarData);
  console.log('UCI Bar Data:', eqGrpUciCatBarData);
  console.log('Number of Categories:', numEQGrpCats);
  console.log('Lookup Table:', lookupTableEqCode);
  console.log('Measure Title:', measureTitle);
  console.log('Start Year:', startYear);
  console.log('Latest Year:', latestYear);
  console.log('Current Dataset Long:', datasetLongName);
  console.log('Section 75 Category Measures:', s75CatMeasures);
  console.log('Section 75 Category Measures Titles:', s75CatMeasuresTitle);
  console.log('Section 75 Category Labels Notes: ',s75CatNotesLabels);
  console.log('Further Information ',furtherInfo);
  console.log('Section 75 Available Groups:', s75grps);
  console.log('matchString', ind);

  let chartInstance = null;

function returnAvailableS75GroupsForAllMeasures(data, lookupTable) {
    if (typeof lookupTable !== 'object' || lookupTable === null) {
        throw new Error("lookupTable must be a valid object");
    }

    // Get all measure codes from metadata
    const measureCodes = Object.entries(data)
        .filter(([key, value]) => key.endsWith('_metadata') && value.dataset)
        .map(([_, value]) => value.dataset);

    const eqPattern = /EQ\d+/g;
    const allEqValues = new Set();

    // For each measure code, find matching keys and extract EQ codes
    measureCodes.forEach(measureCode => {
        const matchedKeys = Object.keys(data).filter(key => key.includes(measureCode));
        matchedKeys.forEach(key => {
            const matches = key.match(eqPattern);
            if (matches) {
                matches.forEach(eq => allEqValues.add(eq));
            }
        });
    });

    // Map EQ codes to Section 75 groups
    const matchedGroups = new Set();

    allEqValues.forEach(eq => {
        for (const [group, eqList] of Object.entries(lookupTable)) {
            if (eqList.includes(eq)) {
                matchedGroups.add(group);
            }
        }
    });

    return [...matchedGroups];
}

// Generating tables for all measures lookup and inter measures page array
const lookupTable = {
    age: ['EQ101', 'EQ102', 'EQ115', 'EQ107', 'EQ103', 'EQ111', 'EQ112', 'EQ108', 'EQ104', 'EQ113', 'EQ114', 'EQ109', 'EQ105', 'EQ106', 'EQ110', 'EQ116', 'EQ117', 'EQ118', 'EQ119', 'EQ120', 'EQ121'],
    depend: ['EQ701', 'EQ702', 'EQ703', 'EQ704'],
    disab: ['EQ401', 'EQ402'],
    ethnic: ['EQ1001', 'EQ1002', 'EQ1003'],
    marital: ['EQ301', 'EQ302', 'EQ303', 'EQ304', 'EQ305', 'EQ306', 'EQ307', 'EQ308', 'EQ309'],
    ori: ['EQ601', 'EQ602', 'EQ603'],
    political: ['EQ901', 'EQ902', 'EQ903', 'EQ904'],
    race: ['EQ801', 'EQ802', 'EQ803'],
    religion: ['EQ501', 'EQ502', 'EQ503', 'EQ504', 'EQ505', 'EQ506', 'EQ507', 'EQ508'],
    sex: ['EQ201', 'EQ202']
};

let allS75Groups = returnAvailableS75GroupsForAllMeasures(data, lookupTable);
console.log("Please Work", allS75Groups);

function getS75ExclusionsFromLineData(data, invertedLookupEqCode) {
    const allGroups = new Set(Object.values(invertedLookupEqCode).flat());
    const measureToIncludedGroups = {};

    // Step 1: Loop through all keys ending in "_line_data"
      Object.keys(data).forEach(key => {
        if (key.endsWith('_line_data')) {
            const parts = key.split('_');
            if (parts.length >= 3) {
                const measure = parts[0];
                const eqCode = parts[1];
              
                // Step 2: Get the Section 75 group(s) for this EQ code
                const groups = invertedLookupEqCode[eqCode];
                if (!groups) return;

                // Step 3: Add to measure's included groups
                if (!measureToIncludedGroups[measure]) {
                    measureToIncludedGroups[measure] = new Set();
                }
                groups.forEach(group => measureToIncludedGroups[measure].add(group));
            }
        }
    });
    // Step 4: Build exclusions object
    const exclusions = {};
    for (const [measure, includedSet] of Object.entries(measureToIncludedGroups)) {
        const excluded = [...allGroups].filter(group => !includedSet.has(group));
        exclusions[measure] = excluded;
    }

    return exclusions;
}
  
const exclusions = getS75ExclusionsFromLineData(data, invertedLookupEqCode);
console.log("Please work!", exclusions);

function getS75InclusionsFromLineData(data, invertedLookupEqCode) {
    const measureToIncludedGroups = {};

    // Loop through all keys ending in "_line_data"
      Object.keys(data).forEach(key => {
      if (key.endsWith('_line_data')) {
          const parts = key.split('_');
          if (parts.length >= 3) {
              const measure = parts[0];
              const eqCode = parts[1];
              // Get the Section 75 group(s) for this EQ code
              const groups = invertedLookupEqCode[eqCode];
              if (!groups) return;

               // Add to measure's included groups
            if (!measureToIncludedGroups[measure]) {
                    measureToIncludedGroups[measure] = new Set();
                }
                groups.forEach(group => measureToIncludedGroups[measure].add(group));
            }
        }
    });
  
    // Convert sets to arrays for easier use
    const inclusions = {};
    for (const [measure, includedSet] of Object.entries(measureToIncludedGroups)) {
        inclusions[measure] = [...includedSet];
    }

    return inclusions;
}

  Chart.register(ChartDataLabels);

  // determine maxValue of the current bar data
  const maxValue = Math.max(...eqGrpCatBarData);
  const maxAvgDiff = niAvgLine - maxValue;

  // Function to calculate padding based on screen size
  function calculateBarPadding() {
    const viewportWidth = window.innerWidth;

    if (maxValue < 75 && maxAvgDiff <= -2 || maxValue >= 75 && maxAvgDiff <= -9){
      if (viewportWidth <= 1024) {
          // Tablet: Medium padding
          return maxValue * 0.11;
      } else if (viewportWidth <=1200) {
          return maxValue * 0.08;
      } else if (viewportWidth <=1500) {
          // Desktop: Larger padding
          return maxValue * 0.06;
      } else {
          return maxValue * 0.04;
      }
    }
    else if (maxValue >= 75 && (maxAvgDiff > -9 && maxAvgDiff <= -4)){
      if (viewportWidth <= 1024) {
          // Tablet: Medium padding
          return maxValue * 0.16;
      } else if (viewportWidth <=1200) {
          return maxValue * 0.13;
      } else if (viewportWidth <=1500) {
          // Desktop: Larger padding
          return maxValue * 0.11;
      } else {
          return maxValue * 0.09;
      }
    }
    else if (maxValue < 75 && (maxAvgDiff > -2 && maxAvgDiff <= -0.5)){
      if (viewportWidth <= 1024) {
          // Tablet: Medium padding
          return maxValue * 0.20;
      } else if (viewportWidth <=1200) {
          return maxValue * 0.17;
      } else if (viewportWidth <=1500) {
          // Desktop: Larger padding
          return maxValue * 0.15;
      } else {
          return maxValue * 0.13;
      }
    }
    else {
      if (viewportWidth <= 1024) {
          // Tablet: Medium padding
          return maxValue * 0.31;
      } else if (viewportWidth <=1200) {
          return maxValue * 0.28;
      } else if (viewportWidth <=1500) {
          // Desktop: Larger padding
          return maxValue * 0.26;
      } else {
          return maxValue * 0.24;
      }
    }
  }

  console.log("max value:", maxValue);
  console.log("average value:", niAvgLine);
  console.log("avg diff:", maxAvgDiff)

  // Initial padding - needs to be different when the average value is close or the same as the max value - set thresholds
  // in calculateBarPadding
  let barPadding = calculateBarPadding();

  // Bar chart function
  function createBarChart(cat_labels, bar_data, ni_line) {
    const ctx_bar_line_chart = document.getElementById('bar_line_chart').getContext('2d');

    let annotationsConfig = {};
    const realBarValCount = bar_data.filter(value => value !== null).length;

    if (ni_line !== 100){
      annotationsConfig = {
        annotations: {
                avg_line: {
                  type: 'line',
                  xMin: ni_line ,             // Set the Y position for the line
                  xMax: ni_line ,             // Same as yMin for a horizontal line
                  borderColor: '#3b80ae',   // Color of the line
                  borderWidth: 6,
                  label: {
                    content: (ctx) => {
                      return [
                        'NI',`${ni_line}%`
                      ];
                    },
                    display: true,       // Ensure label is displayed
                    position: 'center',     // Position of the label
                    backgroundColor: 'rgba(255, 255, 255, 1)', // Optional: Label background color,
                    color: 'black',      // Optional: Text color for the label
                    font: {
                      size: 18,        // Font size of the label text
                      weight: 'bold'
                    },
                    padding: 4,           // Optional: Padding around the label
                    borderColor: 'black',
                    borderWidth: 3,
                    borderRadius: 1,
                    callout: {
                      display: true,
                      color: 'black',
                      width: 30,
                      length: 10
                    },
                    xAdjust: 80
                  },
                },
              },
            };
      }
    
    
    if (realBarValCount >=1){
      chartInstance = new Chart(ctx_bar_line_chart, {
        type: 'bar',
        data: {
          labels: cat_labels,
          datasets: [{
            label:`Group value`,
            data: bar_data,
            backgroundColor: '#00205B',
            datalabels: {
              display: true,
              anchor: 'start',
              align: 'end',
              formatter: (value) => `${value}%`,
              color: '#fff',      // Set the label color
              font: {
                size: 22
              }
            },
            order: 2
          }]
        },
        options: {
          indexAxis: 'y',
          events: [], // turn off hover labels //
          plugins: {
            legend: {
              display: false
            },
            // suppress datalabels globally for this chart - turned on individually for each dataset as needed
            datalabels: {
              display: false
            },
            title: {
              display: false,
            },
            customLinePlugin: false, // Disable the line mouseover plugin for this chart
            annotation: annotationsConfig,
          },
          scales: {
            y: {
              grid: {
                display: false
              },
              border: {
                display: true,
                width: 3,
                color: '#00205B'
              },
              ticks: {
                display: true,
                font: {
                  size: 16
                }
              }
            },
            x: {
              grid: {
                display: false
              },
              border: {
                display: false
              },
              min: 0,
              max: maxValue + barPadding,
              ticks: {
                display: false,
              }
            }
          }
        }
      }
    )
    }else{
          barInfoContainer.style.display = "none";
          document.getElementById('chartView').innerHTML = '<center style="font-weight: bold; font-size: 18pt;">Current year data is not available for this measure<br><br></center>';
          
        }

  };

  const latest_year = document.querySelectorAll('.latest_year');
  for (let i = 0; i < latest_year.length; i++) {
    latest_year[i].innerHTML = latestYear;
  }

  const start_year = document.querySelectorAll('.start_year');
  for (let i = 0; i < start_year.length; i++) {
    start_year[i].innerHTML = startYear;
  }

  const eq_grp_name = document.querySelectorAll('.eq_grp_name');
  for (let i = 0; i < eq_grp_name.length; i++) {
    eq_grp_name[i].innerHTML = eqGrpDisplayName;
  }

  const measure_title = document.querySelectorAll('.measure_title');
  for (let i = 0; i < measure_title.length; i++) {
    measure_title[i].innerHTML = measureTitle;
  }

  const measure_title_table = document.querySelectorAll('.measure_title_table');
  for (let i = 0; i < measure_title_table.length; i++) {
    measure_title_table[i].innerHTML = measureTitle + " (%)";
  }

  const measures_in_group = document.querySelectorAll('.measures_in_group');
  for (let i = 0; i < measures_in_group.length; i++) {
    measures_in_group[i].innerHTML = s75CatMeasures;
  }

  const notes_in_group = document.querySelectorAll('.notes_in_group');
  for (let i = 0; i < notes_in_group.length; i++) {
    notes_in_group[i].innerHTML = s75CatNotesLabels;
  }

  const notes_in_measure = document.querySelectorAll('.notes_in_measure');
  for (let i = 0; i < notes_in_measure.length; i++) {
    notes_in_measure[i].innerHTML = furtherInfo;
  }

  // create ul containing all the measure titles that are split by the s75 current group
  const measures_in_group_titles = document.querySelectorAll('.measures_in_group_titles');

  // Generate the <ul> structure
  const ulElement = document.createElement('ul');
  s75CatMeasuresTitle.forEach(title => {
    const liElement = document.createElement('li');
    liElement.textContent = title; // Add the title as the text of the <li>
    ulElement.appendChild(liElement); // Append the <li> to the <ul>
  });

  // Replace the content of each target element with the generated <ul>
  for (let i = 0; i < measures_in_group_titles.length; i++) {
    measures_in_group_titles[i].innerHTML = ''; // Clear existing content
    measures_in_group_titles[i].appendChild(ulElement.cloneNode(true)); // Append the <ul> to each element
  }

  let how_measure = data[`${ind}_how_do_we_measure`];
  const howElem = document.getElementById("how_do_we_measure");
  if (howElem && how_measure) {
  howElem.innerHTML = how_measure;
  }
  let sourceUrl = data[`${ind}_source_url`];
  document.getElementById("sourceId").href = sourceUrl

  let sourceName = data[`${ind}_source_name`];

  const source_name = document.querySelectorAll('.source_name');
  for (let i = 0; i < source_name.length; i++) {
    source_name[i].innerHTML = sourceName;
  }

  let dataPortalUrl = `https://data.nisra.gov.uk/table/${datasetLongName}`
  document.getElementById("portalId").href = dataPortalUrl

  const dataportal_name = document.querySelectorAll('.dataportal_name');
  for (let i = 0; i < dataportal_name.length; i++) {
    dataportal_name[i].innerHTML = dataPortalUrl;
  }


  document.getElementById("notes_in_measure").innerHTML = furtherInfo;

  document.getElementById("notes_in_group").innerHTML = s75CatNotesLabels;

  const notesInMeasure = document.getElementById("notes_in_measure");
  const measureNotesParagraph = document.getElementById("measureNotesParagraph");
  if (notesInMeasure && notesInMeasure.innerHTML.trim()!= ""){
     measureNotesParagraph.style.display = "block";
  } else {
     measureNotesParagraph.style.display = "none";
  }
 
  const notesInGrp = document.getElementById("notes_in_group");
  const groupNotesParagraph = document.getElementById("groupNotesParagraph");
  if (notesInGrp && notesInGrp.innerHTML.trim()!= ""){
     groupNotesParagraph.style.display = "block";
  } else {
     groupNotesParagraph.style.display = "none";
  }


  function populateTable() {
    const tableBody = document.getElementById("dataTable").getElementsByTagName("tbody")[0];
    dataTable.classList.add('dest-table');
    tableBody.innerHTML = "";

    // Ensure niAvgLine is treated as a single value (if it's not an array)
    const niValue = Array.isArray(niAvgLine) ? niAvgLine[0] : niAvgLine;
    const tableDataArray = [];

    const allLciNull = eqGrpLciCatBarData.every(val => val ===null);
    const allUciNull = eqGrpUciCatBarData.every(val => val ===null);
    const realTabValCount = eqGrpCatBarData.filter(value => value !== null).length;

    if (realTabValCount >=1){

      const headerRow = document.createElement("tr");
      const headers = [eqGrpDisplayName,measureTitle];
      if(!allLciNull) headers.push("LCI (%)");
      if(!allUciNull) headers.push("UCI (%)");
      if(niValue !== 100) headers.push("NI Value (%)");

      headers.forEach((headerText,index) => {
        const headerCell = document.createElement("th");
        
        if (index === 0) {
          headerCell.className = "eq_grp_name";
          headerCell.textContent = headerText;
        } else if (index === 1){
          headerCell.className = "measure_title_table";
          headerCell.textContent = headerText;
        }  else {
          headerCell.textContent = headerText;
        }
        headerRow.appendChild(headerCell);
      });
      document.getElementById("dataTable").getElementsByTagName("thead")[0].appendChild(headerRow);

      for (let i = 0; i < eqGrpCatLabels.length; i++) {
          const row = document.createElement("tr");

          const ageCell = document.createElement("td");
          ageCell.textContent = eqGrpCatLabels[i];
          row.appendChild(ageCell);

          const povCell = document.createElement("td");
          povCell.textContent = eqGrpCatBarData[i] !== null ? eqGrpCatBarData[i] : "N/A";
          row.appendChild(povCell);

          if (!allLciNull && realTabValCount >=1){
            const lcipovCell = document.createElement("td");
            lcipovCell.textContent = eqGrpLciCatBarData[i] !== null ? eqGrpLciCatBarData[i] : "N/A";
            row.appendChild(lcipovCell);
          }

          if (!allUciNull && realTabValCount >=1){
            const ucipovCell = document.createElement("td");
            ucipovCell.textContent = eqGrpUciCatBarData[i] !== null ? eqGrpUciCatBarData[i] : "N/A";
            row.appendChild(ucipovCell);
          }

          if (niValue !== 100){
            const niCell = document.createElement("td");
            niCell.textContent = niValue;
            row.appendChild(niCell);
          }

          tableBody.appendChild(row);

          // Store data as an object
          tableDataArray.push({
              category: eqGrpCatLabels[i],
              percentage: parseFloat(eqGrpCatBarData[i]), // Convert to number
              niAverage: parseFloat(niValue) // Convert to number
          });
    }}else{
      document.getElementById('dataTable').innerHTML = '<center style="font-weight: bold; font-size: 18pt;">Current year data is not available for this measure</center>';

    }

    // Generate summary using the new function
    const summaryText = generateSummaryText(tableDataArray, niAvgLine, measureTitle, eqGrpDisplayName, how_measure);

    // Update all elements with the class 'data_summary'
    document.querySelectorAll('.data_summary').forEach(el => {
        el.innerHTML = summaryText;
    });

    console.log("Summary:", summaryText); // Debugging log

    return {
        tableData: tableDataArray,
        summary: summaryText
    };
  }

  function populateTable2() {
  const tableBody2 = document.getElementById("dataTable2").getElementsByTagName("tbody")[0];
  dataTable2.classList.add('dest-table');
  tableBody2.innerHTML = "";

  // Replace the keys in the object with the new labels from the array
  let updatedObject = Object.keys(eqGrpCatLineData).reduce((acc, key, index) => {
    acc[eqGrpCatLabels[index]] = eqGrpCatLineData[key]; // Use new label from the array
  return acc;
                 }, {});

  let ni_line_object = {"NI Value": niLineData}
  let year_object = {Year: yearLabels}
  //  let ni_object = {...eqGrpCatLineData}
  
  let eqGrpCatLineData2 = {...year_object, ...updatedObject,
    ...ni_line_object
  }
  
  // Update the header dynamically based on eqGrpCatLineData
  const ageGroups = Object.keys(eqGrpCatLineData2);
  
  // Clear the existing header
  const ageGroupHeaders = document.getElementById("ageGroupHeaders");
  ageGroupHeaders.innerHTML = ""; // Clear existing headers

  // Add each age group as a separate header in the table
  ageGroups.forEach(group => {
    const th = document.createElement("th");
    th.textContent = group; // Set age group label as column header
    ageGroupHeaders.appendChild(th);
  });

  // Assume niAvgLine is a dynamic array or value for National Index values
  const niValue = Array.isArray(niAvgLine) ? niAvgLine[0] : niAvgLine;

  // Table data container
  const tableDataArray = [];

  // Check if the data is available for the selected years
  if (yearLabels && yearLabels.length > 0) {
    for (let i = 0; i < yearLabels.length; i++) {
        const row = document.createElement("tr");


        // Add dynamic cells for each age group
        ageGroups.forEach(group => {
            const ageCell = document.createElement("td");
            ageCell.textContent = eqGrpCatLineData2[group][i] || "N/A"; // Handle missing data
            row.appendChild(ageCell);
        });

        tableBody2.appendChild(row);

        // Store data for summary generation
        tableDataArray.push({
            year: yearLabels[i],
            data: ageGroups.reduce((acc, group, index) => {
                acc[group] = parseFloat(eqGrpCatLineData2[group][i]) || 0;
                return acc;
            }, {}),
            niAverage: parseFloat(niValue) || 0
        });
    }
  } else {
    document.getElementById('dataTable2').innerHTML = '<center style="font-weight: bold; font-size: 18pt;">Current year data is not available for this measure</center>';
  }

  // Create a new object with labels replaced by the array values
const eqGrpCatLineData4 = Object.keys(eqGrpCatLineData).reduce((acc, key, index) => {
  acc[eqGrpCatLabels[index]] = eqGrpCatLineData[key]; // Replace key with value from arr
  return acc;
}, {});

const yearLabels2 = ["2001/02", "2002/03", "2003/04"];

const eqGrpCatLineData3 = {
    "16-24": [12, 22, 62],
    "25-34": [0, 32, 42], // 2001 is missing, assumed 0
    "35-49": [52, 32, 12]
};
const niLineData2 = [12, 11, 10]; // Example placeholder values

let tableDataArray2 = [];

for (let i = 0; i < yearLabels.length; i++) {
    let year = yearLabels[i];
    
    let yearData = {
        year: parseInt(year), // Convert to number
        data: {},
        niAverage: parseFloat(niLineData[i]) || 0
    };

    // Assign values for each age group
    Object.keys(eqGrpCatLineData4).forEach(group => {
        yearData.data[group] = parseFloat(eqGrpCatLineData4[group][i]) || 0;
    });

    tableDataArray2.push(yearData);
}
console.log("Tests:", tableDataArray2);

const summaryText2 = generateSummaryText2(
    tableDataArray2, 
    niLineData[0], 
    measureTitle, 
    Object.keys(eqGrpCatLineData4), 
    how_measure
);

document.getElementById('data_summary_2').innerHTML = summaryText2;
  
return {
    tableData: tableDataArray2,
    summary: summaryText2
  };

}

function toLowercase(str) {
  return String(str || '').toLowerCase();
}

function toTitleCase(str) {
  return String(str || '')
    .toLowerCase()
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

// Function to generate summary in the requested format
function generateSummaryText(tableData, niAverage, measureTitle, eqGrpDisplayName, howMeasure) {
    if (!Array.isArray(tableData) || tableData.length === 0) {
        console.warn("No valid data to summarize.");
        return "No data available for summary.";
    }

    let categoriesWithDiff = [];

    // Calculate differences and store categories with values
    tableData.forEach(row => {
        let category = row.category;
        let percentage = parseFloat(row.percentage);

        if (isNaN(percentage)) {
            categoriesWithDiff.push({
                category: category,
                isValid: false
            });
            return;
        }

        let diff = percentage - niAverage;
        let direction = diff > 0 ? "higher" : diff < 0 ? "lower" : "same";

        categoriesWithDiff.push({
            category: category,
            percentage: percentage.toFixed(0),
            difference: Math.abs(diff).toFixed(0),
            direction: direction,
            isValid: true
        });
    });

    // Separate valid and invalid categories
    let validCategories = categoriesWithDiff.filter(item => item.isValid);
    let invalidCategories = categoriesWithDiff.filter(item => !item.isValid);

    // Ensure categories follow the original order from eqGrpCatLabels (from data.js)
    if (typeof eqGrpCatLabels !== 'undefined' && Array.isArray(eqGrpCatLabels)) {
       validCategories.sort((a, b) => eqGrpCatLabels.indexOf(a.category) - eqGrpCatLabels.indexOf(b.category));
    }

     // Keep the original order from eqGrpCatLabels and output in that order.
     // Precompute lower-only items for census-specific bolding logic
     const lowerOnly = validCategories.filter(item => item.direction === "lower");
     const highestLower = lowerOnly.length
         ? lowerOnly.reduce((max, cur) => parseFloat(cur.percentage) > parseFloat(max.percentage) ? cur : max, lowerOnly[0])
         : null;
     const lowestLower = lowerOnly.length
         ? lowerOnly.reduce((min, cur) => parseFloat(cur.percentage) < parseFloat(min.percentage) ? cur : min, lowerOnly[0])
         : null;

    let summaryText = {};

    if (niAverage !== 100) {

        summaryText = `${measureTitle} ${latestYear}<br>`;
        summaryText += `This measure records the <span style="text-transform:lowercase">${howMeasure}</span> The NI value for ${measureTitle} is ${niAverage}%.<br>`;
        summaryText += `Looking at differences by ${eqGrpDisplayName} compared to the NI value:<br>`;

        // Output every valid category in the original eqGrpCatLabels order
        validCategories.forEach(entry => {
            let pointLabel = entry.difference === "1" ? "percentage point" : "percentage points";
            if (entry.direction === "same") {
                summaryText += `${entry.category}: ${entry.percentage}% (the same as the NI value)<br>`;
            } else {
                let formattedText = `${entry.category}: ${entry.percentage}% (${entry.difference} ${pointLabel} ${entry.direction})<br>`;
                summaryText += formattedText;
            }
        });
    } else {
        summaryText = `${toTitleCase(measureTitle)} - ${latestYear} Census<br>`;
        summaryText += `The ${toLowercase(measureTitle)} is broken down by ${eqGrpDisplayName} as follows:<br>`;

        // Output categories in original order; bold the highest/lowest among 'lower' direction items
        validCategories.forEach(entry => {
            let formattedText = `${entry.category}: ${entry.percentage}%<br>`;
            summaryText += formattedText;
        });
    }

    // Add invalid category summary text
    if (invalidCategories.length > 0) {
        invalidCategories.forEach(entry => {
            summaryText += `${entry.category} data is not available and hence cannot be compared.<br>`;
        });
    }

    return summaryText;
}

function generateSummaryText2(tableData, niAverage, measureTitle, ageGroups, howMeasure) {
    if (!Array.isArray(tableData) || tableData.length < 2) {
        console.warn("Not enough data to summarize.");
        return "Not enough data available for summary.";
    }

    const firstYearLabel = tableData[0].year;
    const lastYearLabel = tableData[tableData.length - 1].year;

    let diffValues = {};

    ageGroups.forEach(group => {
        const firstRow = tableData[0];
        const lastRow = tableData[tableData.length - 1];

        const firstGroupVal = firstRow?.data[group] || 0;
        const firstNI = firstRow?.niAverage || 0;
        const firstDiff = Math.round(firstGroupVal - firstNI);

        const lastGroupVal = lastRow?.data[group] || 0;
        const lastNI = lastRow?.niAverage || 0;
        const lastDiff = Math.round(lastGroupVal - lastNI);

        diffValues[group] = {
            firstDiff,
            lastDiff,
            change: lastDiff - firstDiff
        };
    });

    const sortedDiffs = Object.entries(diffValues).sort((a, b) => b[1].change - a[1].change);
    const biggestIncrease = sortedDiffs[0];
    const biggestDecrease = sortedDiffs[sortedDiffs.length - 1];

    function toFinancialYear(year) {
    const nextYear = (parseInt(year) + 1).toString().slice(-2); // Gets last two digits
    return `${year}/${nextYear}`; 
    }

    const firstYearLabels = toFinancialYear(tableData[0].year);
    const lastYearLabels = toFinancialYear(tableData[tableData.length - 1].year);
    
    let summaryText = `${measureTitle} ${firstYearLabels} to ${lastYearLabels}<br>`;
    summaryText += `This measure records the <span style="text-transform:lowercase">${howMeasure}</span><br>`;
    summaryText += `Looking at trends by ${eqGrpDisplayName} compared to the NI value:<br>`;

    summaryText += `${biggestIncrease[0]}: This group showed the highest increase relative to the NI value from ${Math.abs(biggestIncrease[1].firstDiff)} percentage points ${
        biggestIncrease[1].firstDiff >= 0 ? "above" : "below"
    } the NI value in ${firstYearLabels} to ${Math.abs(biggestIncrease[1].lastDiff)} percentage points ${
        biggestIncrease[1].lastDiff >= 0 ? "above" : "below"
    } in ${lastYearLabels}.<br>`;

    summaryText += `${biggestDecrease[0]}: This group showed the greatest decrease relative to the NI value from ${Math.abs(biggestDecrease[1].firstDiff)} percentage points ${
        biggestDecrease[1].firstDiff >= 0 ? "above" : "below"
    } the NI value in ${firstYearLabels} to ${Math.abs(biggestDecrease[1].lastDiff)} percentage points ${
        biggestDecrease[1].lastDiff >= 0 ? "above" : "below"
    } in ${lastYearLabels}.<br>`;

    return summaryText;
}


document.addEventListener("DOMContentLoaded", () => {
  const button = document.querySelector(".copy-button");
    button.addEventListener("click", copyTable);
  });

  document.addEventListener("DOMContentLoaded", () => {
  const button = document.getElementById("copy-button2");
  button.addEventListener("click", copyTable2);
  });

  function copyTable(){
    const table = document.getElementById("dataTable");
    if (!table) {
      alert("Table not found");
      return;
    }

    // clone table to remove html specific styles
    const clonedTable = table.cloneNode(true);

    // remove unnecessary inline styles
    clonedTable.removeAttribute("style");
    clonedTable.querySelectorAll("th, td").forEach(cell => {
      cell.removeAttribute("style");
    });

    // add cloned table to a hidden container in the DOM. to allow copying the table from button above table
    const hiddenContainer = document.createElement("div");
    hiddenContainer.style.position = "absolute";
    hiddenContainer.style.left = "-9999px"; // move it off screen
    hiddenContainer.appendChild(clonedTable);
    document.body.appendChild(hiddenContainer);

    // use cloned table for copying
    const range = document.createRange();
    range.selectNode(clonedTable);
    const selection = window.getSelection();
    // window.getSelection().removeAllRanges();
    // window.getSelection().addRange(range);
    selection.removeAllRanges();
    selection.addRange(range);
    document.execCommand("copy");
    // window.getSelection().removeAllRanges();
    // alert("Table copied to clipboard");

    // cleanup
    document.body.removeChild(hiddenContainer);
    selection.removeAllRanges();
    alert("Table copied to clipboard");
  }

  function copyTable2(){
    const table = document.getElementById("dataTable2");
    if (!table) {
      alert("Table not found");
      return;
    }

    // clone table to remove html specific styles
    const clonedTable = table.cloneNode(true);

    // remove unnecessary inline styles
    clonedTable.removeAttribute("style");
    clonedTable.querySelectorAll("th, td").forEach(cell => {
      cell.removeAttribute("style");
    });

    // add cloned table to a hidden container in the DOM. to allow copying the table from button above table
    const hiddenContainer = document.createElement("div");
    hiddenContainer.style.position = "absolute";
    hiddenContainer.style.left = "-9999px"; // move it off screen
    hiddenContainer.appendChild(clonedTable);
    document.body.appendChild(hiddenContainer);

    // use cloned table for copying
    const range = document.createRange();
    range.selectNode(clonedTable);
    const selection = window.getSelection();
    // window.getSelection().removeAllRanges();
    // window.getSelection().addRange(range);
    selection.removeAllRanges();
    selection.addRange(range);
    document.execCommand("copy");
    // window.getSelection().removeAllRanges();
    // alert("Table copied to clipboard");

    // cleanup
    document.body.removeChild(hiddenContainer);
    selection.removeAllRanges();
    alert("Table copied to clipboard");
  }

  // click event listeners for download chart image button
  document.getElementById('downloadButton').addEventListener('click', () => downloadChart());

  // // set chart background to white. default is transparent for download
  const backgroundColorPlugin = {
     id: 'customCanvasBackgroundColor',
     beforeDraw: (chart) => {
       const ctx = chart.canvas.getContext('2d');
       const {width,height} = chart;
       ctx.save();
       //ctx.globalCompositeOperation = 'destination-over';
       ctx.fillStyle = 'white';
       ctx.fillRect(0, 0, width, height);
      
       //add title
       //ctx.fillStyle = 'black';
       //ctx.font = 'bold 18px Arial';
       //ctx.textAlign = 'center';
       //ctx.fillText(measureTitle,width/2,25);
       
       ctx.restore();
     }
   }
   Chart.register(backgroundColorPlugin);

  function downloadChart() {
    if (chartInstance) {
        const chartCanvas = chartInstance.canvas;
        const extraTitleSpace = 35;
        const extraWatermarkTitleSpace = 50;
        const extraSpacingBetweenTitleAndSubheading = 15; // Space between title & subheading
        const extraSpacingAfterSubheading = 15; // Space between subheading and "Measure split by"
        const originalWidth = chartCanvas.width;
        const originalHeight = chartCanvas.height;

        // Get the subheading text
        let measureText = document.getElementById("how_do_we_measure").innerText || "";
        measureText = measureText.slice(0, measureText.length - 1); // Trim last character if needed
        let groupName = document.querySelector(".eq_grp_name").innerText.toLowerCase();
        
        // Capitalize the first letter of groupName
        groupName = groupName.charAt(0).toUpperCase() + groupName.slice(1);
        
        const subHeading = `${measureText}`; // Main subheading text
        const groupHeading = "Split by"; // Static text

        // Create a new canvas
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = originalWidth;
        const ctx = tempCanvas.getContext('2d');

        // Calculate text wrapping for subheading
        ctx.font = '24px sans-serif';
        const maxWidth = originalWidth * 0.8; // Limit width to 80% of the canvas to allow for margins
        const lineHeight = 30;
        const subHeadingLines = wrapText(ctx, subHeading, maxWidth);
        const extraMeasureSpace = (subHeadingLines.length * lineHeight) + lineHeight + extraSpacingAfterSubheading;

        // Adjust canvas height
        tempCanvas.height = originalHeight + extraTitleSpace + extraMeasureSpace + extraWatermarkTitleSpace + extraSpacingBetweenTitleAndSubheading;

        // Fill background
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

        // Add title
        ctx.fillStyle = 'black';
        ctx.font = 'bold 30px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(measureTitle + ' ' + latestYear, originalWidth / 2, 25);

        // Add extra space before subheading
        let yPosition = 50 + extraSpacingBetweenTitleAndSubheading;

        // Draw subheading (normal text) line by line
        ctx.font = '24px sans-serif';
        ctx.fillStyle = 'black';
        subHeadingLines.forEach(line => {
            ctx.fillText(line, originalWidth / 2, yPosition);
            yPosition += lineHeight;
        });

        // Move down slightly for "Measure split by {groupName}"
        yPosition += extraSpacingAfterSubheading;

        // Set text alignment to left for natural spacing
        ctx.textAlign = 'left';

        // Find total text width to center them as a unit
        ctx.font = '24px sans-serif';
        const groupHeadingWidth = ctx.measureText(groupHeading).width;
        ctx.font = 'bold 24px sans-serif';
        const groupNameWidth = ctx.measureText(groupName).width;
        const totalWidth = groupHeadingWidth + groupNameWidth + 10; // 10px spacing
        const startX = (originalWidth - totalWidth) / 2;

        // Draw "Measure split by" in normal text
        ctx.font = '24px sans-serif';
        ctx.fillStyle = 'black';
        ctx.fillText(groupHeading, startX, yPosition);

        // Draw groupName in bold and blue (#3878c5), right after "Measure split by"
        ctx.font = 'bold 24px sans-serif';
        ctx.fillStyle = '#3878c5';
        ctx.fillText(groupName, startX + groupHeadingWidth + 5, yPosition); // 5px space

        // Draw the chart
        ctx.drawImage(chartCanvas, 0, extraTitleSpace + extraMeasureSpace + extraSpacingBetweenTitleAndSubheading);

        // Load and add watermark
        const watermark = new Image();
        watermark.src = 'img/nisra-only-colour.png';
        watermark.onload = function () {
            const wmWidth = watermark.width * 0.5;
            const wmHeight = watermark.height * 0.5;
            const wmX = tempCanvas.width - wmWidth - 10;
            const wmY = tempCanvas.height - wmHeight - 10;

            ctx.drawImage(watermark, wmX, wmY, wmWidth, wmHeight);

            // Download chart
            const link = document.createElement('a');
            const chart_image_filename = measureTitle + ` ` + latestYear.slice(0, 4) + `-` + latestYear.slice(5, 7) + `.png`;
            link.href = tempCanvas.toDataURL('image/png');
            link.download = chart_image_filename;
            link.click();
        };
    }
  }

  // Function to wrap text into multiple lines
  function wrapText(ctx, text, maxWidth) {
    const words = text.split(' ');
    let lines = [];
    let currentLine = words[0];

    for (let i = 1; i < words.length; i++) {
        let testLine = currentLine + ' ' + words[i];
        if (ctx.measureText(testLine).width < maxWidth) {
            currentLine = testLine;
        } else {
            lines.push(currentLine);
            currentLine = words[i];
        }
    }
    lines.push(currentLine);
    return lines;
  }
 
  // click event listeners for view chart and view table buttons
  document.getElementById('chartBtn').addEventListener('click', () => showView('chartView'));
  document.getElementById('tableBtn').addEventListener('click', () => showView('tableView'));

  // Button event listeners for section 2
  document.getElementById('line_chartBtn').addEventListener('click', () => showView('chartContainer'));
  document.getElementById('line_tableBtn').addEventListener('click', () => showView('tableView2'));

  function showView(viewId) {
  const tableView = document.getElementById("tableView");
  const chartView = document.getElementById("chartView");
  const chartButton = document.getElementById('chartBtn');

  const tableView2 = document.getElementById("tableView2");
  const chartView2 = document.getElementById("chartContainer");
  const chartButton2 = document.getElementById('line_chartBtn');

  const legend = document.querySelector('.chart-legend');

  // Handle the first section: Table/Chart Toggle
  if (viewId === 'tableView') {
    tableView.style.display = "block";
    chartView.style.display = "none";

    // Add 'inactive' class to chartButton to avoid inline coding here and remove 'selected'
    chartButton.classList.add('inactive');
    chartButton.classList.remove('selected');
    /* chartButton.style.backgroundColor = '#7e6ec4';
    chartButton.style.color = '#fff'; */
    // Only destroy the bar chart when it's in the 'chartView'
    if (chartInstance && chartView.style.display === "block") {
      chartInstance.destroy();
      chartInstance = null;
    }
  } else if (viewId === 'chartView') {
    tableView.style.display = "none";
    chartView.style.display = "block";

    // Remove 'inactive' and switch to 'selected' styling for chart button
  chartButton.classList.remove('inactive');
  chartButton.classList.add('selected');
    /* chartButton.style.backgroundColor = '#fff';
    chartButton.style.color = '#00205b'; */
    if (!chartInstance) {
      createBarChart(eqGrpCatLabels, eqGrpCatBarData, niAvgLine);
    }
  }

  // Handle the second section: Line Chart/Table Toggle
  if (viewId === 'tableView2') {
    tableView2.style.display = "block";
    chartView2.style.display = "none";
    chartButton2.classList.add('inactive');
    chartButton2.classList.remove('selected');
   /*  chartButton2.style.backgroundColor = '#7e6ec4';
    chartButton2.style.color = '#fff'; */
    legend.style.display = 'none'; // Hide the legend
    // Don't destroy the bar chart here
    populateTable2()
    if (lineChartInstance) {
      lineChartInstance.destroy();
      lineChartInstance = null;
    }
  } else if (viewId === 'chartContainer') {
    tableView2.style.display = "none";
    chartView2.style.display = "grid";
    chartButton2.classList.remove('inactive');
    chartButton2.classList.add('selected');
    /* chartButton2.style.backgroundColor = '#fff';
    chartButton2.style.color = '#00205b'; */
    if (nonNull !== 1){
      legend.style.display = 'block';
    }
     // dont Show the legend
    // Only destroy the line chart when necessary
    if (!lineChartInstance) {
      createMultipleLineCharts(eqGrpCatLineData, niLineData, containerId, eqGrpCatLabels, yearLabels);
    }
  }
}
  
  // Function to populate the table and create charts
  window.onload = function() {
    populateTable();
    populateTable2();
    showView('chartView');
    showView('chartContainer');
  };

  // funcitonality for click button copying of descriptive text
  document.getElementById('copyTextButton').addEventListener('click', copyText);
  
  function copyText() {
    // Select the paragraph with the class 'data_summary'
    const textToCopy = document.querySelector('.data_summary').innerText;
    
    // Use Clipboard API for copying text
    navigator.clipboard.writeText(textToCopy)
      .then(() => {
          // Provide feedback to the user via alert
          alert('Text copied to clipboard!');
      })
      .catch(err => {
          console.error('Failed to copy text: ', err);
      });
  }

  document.getElementById('copyTextButton2').addEventListener('click', copyText2);

  function copyText2() {
    const textToCopy = document.getElementById('data_summary_2').innerText;

    navigator.clipboard.writeText(textToCopy)
      .then(() => {
        alert('Text copied to clipboard!');
      })
      .catch(err => {
        console.error('Failed to copy text: ', err);
      });
  }

  const customLinePlugin = {
    id: 'customLinePlugin',
    afterDatasetsDraw(chart, args, pluginOptions) {
        const { ctx, chartArea: { left, right, top, bottom }, tooltip } = chart;

        if (tooltip && tooltip._active && tooltip._active.length) {
            const x = tooltip._active[0].element.x;

            ctx.save();
            ctx.beginPath();
            ctx.moveTo(x, top);
            ctx.lineTo(x, bottom);
            ctx.lineWidth = 2;
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.stroke();
            ctx.restore();
        }
    }
  };
  // this makes the above Plugin available to any chart with tooltips turned on
  Chart.register(customLinePlugin);

  // Update padding dynamically on resize
  window.addEventListener('resize', () => {
    barPadding = calculateBarPadding(); // Recalculate padding
    chart.options.scales.x.max = maxValue + barPadding; // Update max value
    chart.update(); // Redraw the chart

  });



  // js to open and close accordion
  let acc = document.getElementsByClassName("accordion-button");
  let i;

  for (i = 0; i < acc.length; i++) {
    acc[i].addEventListener("click", function() {
      /* Toggle between adding and removing the "active" class,
      to highlight the button that controls the panel */
      this.classList.toggle("active");

      /* Toggle between hiding and showing the active panel */
      let panel = this.nextElementSibling;
      if (panel.style.maxHeight) {
        panel.style.maxHeight = null;
      } else {
        panel.style.maxHeight = panel.scrollHeight + "px";
      }
    });
  }
  
  function createMultipleLineCharts(dataObject, secondSeriesValues, containerId, categoryLabels, years) {
    // Get the container where charts will be appended
    const container = document.getElementById(containerId);

    // Clear the container to avoid duplicates
    container.innerHTML = '';

    // Check if the legend already exists, if not, create it
    let legend = document.querySelector('.chart-legend');
    if (!legend) {
        // Create a new legend if it doesn't exist
        legend = document.createElement('div');
        legend.classList.add('chart-legend'); // Add class for styling

        // Define the legend entries
        legend.innerHTML = `
            <div style="display: flex; gap: 20px; justify-content: center; align-items: center; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="width: 20px; height: 4px; background-color: #00205b; display: inline-block;"></span>
                    <span>Group Value (%)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="width: 20px; height: 4px; background-color: #3b80ae; display: inline-block; border-bottom: 2px dashed #3b80ae;"></span>
                    <span>NI Value (%)</span>
                </div>
            </div>
        `;

        // Insert the legend before the container without affecting the layout
        container.parentNode.insertBefore(legend, container);
    }

    // Get all keys from the dataObject
    const keys = Object.keys(dataObject);

    // Loop through each key in the dataObject
    keys.forEach((key, index) => {
        // Generate a unique ID for the canvas element
        const canvasId = `chartCanvas${index}`;

        const chartDiv = document.createElement("div");
        chartDiv.classList.add('div-style-line'); // Add a class for styling

        // Create a canvas element for each chart
        const canvas = document.createElement('canvas');
        canvas.id = canvasId;

        chartDiv.appendChild(canvas);

        // Append the canvas to the container
        container.appendChild(chartDiv);

        // Get the data for the current series
        const firstSeriesData = dataObject[key];

        var arr = firstSeriesData;
        var count = 0;
        var x = (arr.length-1);
        while (x--) {
            if (arr[x] === null){
                count++;                  
            }     
        }
        console.log(count); 
        nonNull = firstSeriesData.length - count;

        // Ensure the length of secondSeriesValues matches firstSeriesData
        if (!firstSeriesData || secondSeriesValues.length !== firstSeriesData.length) {
            console.warn(`Invalid data for key "${key}"`);
            return;
        }

        // Get the category label for the current chart
        const categoryLabel = categoryLabels && categoryLabels[index]
            ? categoryLabels[index]
            : `Category ${index + 1}`;

        // Create the labels array using categoryLabel and the years array
        const labels = firstSeriesData.map((_, i) => `${categoryLabel} - ${years[i] || `Year ${i + 1}`}`);

        const labelyears = years; 

        // Create the context for the chart
        const ctx = canvas.getContext('2d');

        if (nonNull !== 1) {
            // Create the chart instance
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: `Group value`,
                            data: firstSeriesData,
                            borderColor: '#00205b',
                            pointRadius: 0,
                            borderWidth: 4
                        },
                        {
                            label: `NI value`,
                            data: secondSeriesValues,
                            fill: false,
                            borderDash: [15, 5],
                            borderColor: '#3b80ae',
                            pointRadius: 0,
                            borderWidth: 2
                        },
                    ],
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        axis: 'x',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: false, // Hide individual chart legends
                        },
                        datalabels: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: categoryLabel, // Keep the chart title to just the category label
                            font: {
                                size: 20
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                callback:function (value, tickIndex, ticks) {
                                    if (tickIndex === 0 || tickIndex === labelyears.length - 1) {
                                        return labelyears[tickIndex];
                                    }
                                    return null;
                                }
                            },
                            border: {
                                display: true
                            }
                        },
                        y: {
                            min: 0,
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxTicksLimit: 5
                            },
                            border: {
                                display: true
                            }
                        }
                    }
                },
            });

        } else {
            chartInfoContainer.style.display = "none";
            lineDataSummaryContainer.style.display = "none";
            legend.style.display = "none";
            container.innerHTML = '<center style="font-weight: bold; font-size: 18pt;">Historic data is not available for this measure</center>';
        }

    });
}

  const containerId = 'chartContainer'; // Make sure this div exists in your HTML

  // Call the function
  createMultipleLineCharts(eqGrpCatLineData, niLineData, containerId, eqGrpCatLabels, yearLabels);


function getQueryParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    home: params.get('home'),
    s75: params.get('s75'),
    key: params.get('key'),
    allmeasures: params.get('allmeasures')
  };
}


function buildBreadcrumb() {
  const { home, s75, key, allmeasures } = getQueryParams();

  // Helpers
  const sep = () => document.createTextNode(' \u003e '); // " > "
  const makeHomeLink = () => {
    const a = document.createElement('a');
    a.href = 'index.html';
    a.textContent = 'Home';
    return a;
  };

  // -------- Case 1: breadcrumb-destination (default trail on measure pages) --------
  {
    const container = document.getElementById('breadcrumb-destination');
    if (container) {
      container.innerHTML = '';

      // Home
      const homeLink = makeHomeLink();
      container.appendChild(homeLink);

      // Optional mid crumb (section link) when s75 or home exists
      if (s75 || home) {
        container.appendChild(sep());

        const measureLink = document.createElement('a');
        const lastRelevantUrl = localStorage.getItem('lastRelevantUrl');

        // Determine mid-crumb label
        let label = 'Measure';
        if (lastRelevantUrl && lastRelevantUrl.includes('allmeasures=')) {
          label = 'All Measures';
        } else if (lastRelevantUrl && lastRelevantUrl.includes('home=')) {
          const sectionKey = lastRelevantUrl.split('home=')[1];
          label = `${lookupTableDisplayGrp[sectionKey] || 'Measure'}`;
        }

        // Fallback URL if nothing stored
        measureLink.href = lastRelevantUrl || `index.html?home=${s75 || home}`;
        measureLink.textContent = label;
        container.appendChild(measureLink);
      }

      // Final crumb: ALWAYS "Destination" (static, non-link) when key is present
      if (key) {
        container.appendChild(sep());
        const destinationSpan = document.createElement('span');
        destinationSpan.textContent = '';
        container.appendChild(destinationSpan);
      }
    }
  }

  // -------- Case 2: home= → breadcrumb-inter-measures --------
  if (home) {
    const container = document.getElementById('breadcrumb-inter-measures');
    if (container) {
      container.innerHTML = '';
      const homeLink = makeHomeLink();
      container.appendChild(homeLink);
      container.appendChild(sep());

      const measureLabel = lookupTableDisplayGrp[home] || 'Measure';
      const measureSpan = document.createElement('span');
      measureSpan.textContent = measureLabel;
      container.appendChild(measureSpan);
    }
  }

  // -------- Case 3: allmeasures= → breadcrumb-all-measures --------
  if (allmeasures !== null && allmeasures !== undefined) {
    const container = document.getElementById('breadcrumb-all-measures');
    if (container) {
      container.innerHTML = '';
      const homeLink = makeHomeLink();
      container.appendChild(homeLink);
      container.appendChild(document.createTextNode(' > All Measures'));
       }
  }
}

  // About button
  function createAboutButton() {
      const button = document.createElement('button');
      button.className = 'btn about-btn';
      button.name = 'aboutbutton';
      button.alt = 'Home';
      button.textContent = 'About Equality Matters';
      button.onclick = () => window.location.href = 'about.html';
      return button;
  }

</script>